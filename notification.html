<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Health Tracker</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { margin:0; padding:0; }
    section { padding: 1rem; }
    .toggle {
      cursor: pointer;
      background: #C7BBB4;
      padding: 0.5rem;
      border-radius: 4px;
      margin: 1rem 0;
      text-align: center;
    }
    .add-toggle { 
      background: #2B2C29; 
      color: #C7BBB4;
      font-size: 0.8rem; 
      padding: 0.5rem;
      transition: all 0.2s ease;
    }
    .add-toggle:hover {
      background: #C7BBB4;
      color: #2B2C29;
      box-shadow: 0 0 12px 2px #2B2C29;
    }
    .section-header {
      font-size: 1.2rem;
      font-weight: bold;
      position: relative;
    }
    .section-header .pin-star {
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      cursor: pointer;
      z-index: 10;
    }
    .section-header .pin-star svg {
      width: 16px;
      height: 16px;
    }
    .section-header .pin-star.pinned svg {
      fill: #F7F6F3;
      stroke: #2B2C29;
      stroke-width: 1;
    }
    .hidden { display: none !important; }
    .subtoggle { font-size: 0.9rem; margin-top: 0.5rem; }
    .form-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
      gap: 1rem; 
      align-items: center; 
    }
    .form-grid label { 
      display: flex; 
      flex-direction: column; 
      font-size: 0.9rem; 
      font-weight: bold; 
    }
    .form-grid input, .form-grid select, .form-grid textarea { 
      width: 100%; 
      font-size: 1rem; 
      padding: 0.4rem; 
      margin-top: 0.3rem; 
      box-sizing: border-box; 
      font-weight: normal; 
    }
    .submit-btn {
      background: #2B2C29;
      color: #C7BBB4;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .submit-btn:hover {
      background: #C7BBB4;
      color: #2B2C29;
    }
    .notification-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    .notification-table th, .notification-table td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    .notification-table th {
      background: #C7BBB4;
      font-weight: bold;
    }
    .question-item {
      border: 1px solid #ccc;
      padding: 0.5rem;
      margin: 0.5rem 0;
      border-radius: 4px;
      background: #f9f9f9;
    }
    .question-item button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
  </style>
  <!-- Avoid 404: use an inline SVG as page favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' ry='3' fill='%232B2C29'/%3E%3Ctext x='8' y='12' font-size='10' text-anchor='middle' fill='white'%3ET%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#2B2C29">
</head>
<body>
  <header>
  <h1>Health Tracker</h1>
  </header>
  <div id="nav-placeholder"></div>
  <script src="nav-loader.js"></script>
  <script>
    // Health Tracker state
    let healthTypes = [];
    let healthNotes = [];
    let nextHealthNoteId = 1;
    let periodCycles = [];
    let nextPeriodId = 1;

    async function loadHealthData(){
      try{
        const res = await fetch('/api/health-data');
        if(!res.ok) throw new Error('Failed to load health-data');
        const data = await res.json();
        healthTypes = Array.isArray(data.healthTypes)?data.healthTypes:[];
        healthNotes = Array.isArray(data.healthNotes)?data.healthNotes:[];
        nextHealthNoteId = Number(data.nextHealthNoteId)||1;
        periodCycles = Array.isArray(data.periodCycles)?data.periodCycles:[];
        nextPeriodId = Number(data.nextPeriodId)||1;
      }catch(e){
        console.warn('Using default health data', e);
        healthTypes = [];
        healthNotes = []; nextHealthNoteId = 1;
        periodCycles = []; nextPeriodId = 1;
      }
    }

    async function saveHealthData(){
      const payload = { healthTypes, healthNotes, nextHealthNoteId, periodCycles, nextPeriodId };
      await fetch('/api/health-data', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    }

    function updateHealthTypeOptions(){
      const sel = document.getElementById('hnType');
      if(!sel) return;
      sel.innerHTML = '';
      healthTypes.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
    }

    function addHealthType(){
      const input = document.getElementById('newHealthType');
      const val = (input.value||'').trim();
      if(!val) return;
      if(!healthTypes.includes(val)) healthTypes.push(val);
      input.value='';
      updateHealthTypeOptions();
      saveHealthData();
      toggle('addHealthTypeForm');
    }

    function toggleHealthDuration(){
      const v = (document.getElementById('hnHasDuration')||{}).value;
      const box = document.getElementById('hnDurationFields');
      if(!box) return;
      if(v==='yes') box.classList.remove('hidden'); else box.classList.add('hidden');
    }

    function addHealthNote(){
      const type = (document.getElementById('hnType')||{}).value;
      const start = (document.getElementById('hnStart')||{}).value;
      const hasDur = (document.getElementById('hnHasDuration')||{}).value === 'yes';
      const end = hasDur ? (document.getElementById('hnEnd')||{}).value : '';
      const intensity = hasDur ? Number((document.getElementById('hnIntensity')||{}).value||0) : 0;
      const notes = (document.getElementById('hnNotes')||{}).value||'';
      if(!type||!start) return;
      const item = { id: String(nextHealthNoteId++).padStart(8,'0'), type, startDate: start, hasDuration: hasDur, endDate: end||'', intensity: intensity||0, notes };
      healthNotes.push(item);
      document.getElementById('hnStart').value='';
      document.getElementById('hnHasDuration').value='no';
      toggleHealthDuration();
      document.getElementById('hnEnd').value='';
      document.getElementById('hnIntensity').value='';
      document.getElementById('hnNotes').value='';
      renderHealthNotes();
      saveHealthData();
      toggle('addHealthNoteForm');
    }

    function renderHealthNotes(){
      const container = document.getElementById('healthNotesList');
      if(!container) return;
      container.innerHTML='';
      if(!healthNotes.length){ container.textContent = 'No health notes yet.'; return; }
      const table=document.createElement('table'); table.className='task-table';
      const head=document.createElement('tr'); head.innerHTML='<th>Type</th><th>Start</th><th>End</th><th>Intensity</th><th>Notes</th><th>Action</th>';
      table.appendChild(head);
      healthNotes.slice().sort((a,b)=> (a.startDate||'').localeCompare(b.startDate||'')).forEach(h=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${h.type||''}</td><td>${h.startDate||''}</td><td>${h.hasDuration?(h.endDate||''):''}</td>`;
        const intensityTd=document.createElement('td');
        const intInput=document.createElement('input'); intInput.type='number'; intInput.min='0'; intInput.max='10'; intInput.value=h.intensity||0; intInput.style.width='5rem';
        intInput.onchange=()=>{ h.intensity=Number(intInput.value||0); saveHealthData(); };
        intensityTd.appendChild(intInput); tr.appendChild(intensityTd);
        const notesTd=document.createElement('td');
        const notesInput=document.createElement('textarea'); notesInput.rows=2; notesInput.style.width='100%'; notesInput.value=h.notes||'';
        notesInput.onchange=()=>{ h.notes=notesInput.value; saveHealthData(); };
        notesTd.appendChild(notesInput); tr.appendChild(notesTd);
        const actionTd=document.createElement('td'); actionTd.style.display='grid'; actionTd.style.gridTemplateColumns='repeat(2,1fr)'; actionTd.style.gap='0.2rem'; actionTd.style.justifyItems='center';
        const editBtn=document.createElement('button');
        editBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="14" height="12" rx="2" fill="#B5A89A"/><path d="m6 2v4m8-4v4" stroke="#2B2C29" stroke-width="2" stroke-linecap="round"/><path d="M3 8h14" stroke="#2B2C29" stroke-width="2"/><circle cx="8" cy="12" r="1" fill="#2B2C29"/><circle cx="12" cy="12" r="1" fill="#2B2C29"/></svg>';
        editBtn.title='Edit'; editBtn.style.background='none'; editBtn.style.border='none'; editBtn.style.cursor='pointer'; editBtn.style.padding='2px';
        editBtn.onclick=()=>{
          const t=prompt('Type:', h.type||''); if(t===null) return;
          const s=prompt('Start date (YYYY-MM-DD):', h.startDate||''); if(s===null) return;
          const hd=confirm('Has duration? Click OK for Yes, Cancel for No');
          let e=''; let inten=h.intensity||0;
          if(hd){ e=prompt('End date (YYYY-MM-DD):', h.endDate||'')||''; inten=Number(prompt('Intensity (0-10):', String(inten))||inten); }
          const n=prompt('Notes:', h.notes||''); if(n===null) return;
          h.type=t.trim(); h.startDate=s; h.hasDuration=hd; h.endDate=hd?e:''; h.intensity=inten; h.notes=n||'';
          saveHealthData(); renderHealthNotes();
        };
        const delBtn=document.createElement('button');
        delBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="8" width="8" height="8" rx="2" fill="#E07A5F"/><rect x="9" y="11" width="2" height="3" rx="1" fill="#fff"/><rect x="8" y="4" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
        delBtn.title='Delete'; delBtn.style.background='none'; delBtn.style.border='none'; delBtn.style.cursor='pointer'; delBtn.style.padding='2px';
        delBtn.onclick=()=>{ if(!confirm('Delete this health note?')) return; healthNotes = healthNotes.filter(x=>x.id!==h.id); saveHealthData(); renderHealthNotes(); };
        actionTd.appendChild(editBtn); actionTd.appendChild(delBtn);
        tr.appendChild(actionTd);
        table.appendChild(tr);
      });
      container.appendChild(table);
    }

    // Period tracker
    function addDays(dateStr, days){ const d=new Date(dateStr); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function addPeriod(){
      const start = (document.getElementById('periodStart')||{}).value;
      if(!start) return;
      const estEnd = addDays(start, 5);
      const cycle = { id: String(nextPeriodId++).padStart(8,'0'), startDate: start, estEndDate: estEnd, endDate: '' , daily: [] };
      periodCycles.push(cycle);
      document.getElementById('periodStart').value='';
      renderPeriods();
      saveHealthData();
      toggle('addPeriodForm');
    }

    function upsertDaily(cycle, date, intensity, symptoms){
      let d = (cycle.daily||[]).find(x=>x.date===date);
      if(!d){ d={date, intensity:intensity||0, symptoms:symptoms||''}; cycle.daily.push(d); }
      d.intensity = Number(intensity||0);
      d.symptoms = symptoms||'';
    }

    function renderDayChip(cycle, date){
      const entry = (cycle.daily||[]).find(x=>x.date===date);
      const intensity = entry?Number(entry.intensity||0):0;
      const symptoms = entry?entry.symptoms||'':'';
      const btn=document.createElement('button');
      btn.style.width='18px'; btn.style.height='18px'; btn.style.borderRadius='4px'; btn.style.border='1px solid #999'; btn.style.padding='0'; btn.style.cursor='pointer'; btn.style.background= intensity>=3?'#E07A5F': intensity===2?'#EFA86E': intensity===1?'#F6C1C1':'#E0E0E0';
      btn.title = `${date}${entry?`\nIntensity: ${intensity}${symptoms?`\nSymptoms: ${symptoms}`:''}`:''}`;
      btn.onclick=()=>{
        const newInt = prompt(`Intensity for ${date} (0-3):`, String(intensity));
        if(newInt===null) return;
        const val = Math.max(0, Math.min(3, Number(newInt)||0));
        const newSym = prompt('Symptoms (comma separated):', symptoms||'');
        upsertDaily(cycle, date, val, newSym||'');
        saveHealthData();
        renderPeriods();
      };
      return btn;
    }

    function renderPeriods(){
      const container = document.getElementById('periodList');
      if(!container) return;
      container.innerHTML='';
      if(!periodCycles.length){ container.textContent = 'No period cycles recorded.'; return; }
      const table=document.createElement('table'); table.className='task-table';
      const head=document.createElement('tr'); head.innerHTML='<th>Start</th><th>Est End</th><th>Actual End</th><th>Daily</th><th>Action</th>';
      table.appendChild(head);
      periodCycles.slice().sort((a,b)=> (b.startDate||'').localeCompare(a.startDate||'')).forEach(c=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${c.startDate||''}</td><td>${c.estEndDate||''}</td>`;
        // actual end date input
        const endTd=document.createElement('td');
        const endInput=document.createElement('input'); endInput.type='date'; endInput.value=c.endDate||''; endInput.onchange=()=>{ c.endDate=endInput.value||''; saveHealthData(); renderPeriods(); };
        endTd.appendChild(endInput); tr.appendChild(endTd);
        // daily chips
        const dailyTd=document.createElement('td');
        const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.flexWrap='wrap'; wrap.style.gap='4px'; wrap.style.maxWidth='420px';
        const endRange = c.endDate && c.endDate < todayISO() ? c.endDate : todayISO();
        const start = new Date(c.startDate);
        const end = new Date(endRange);
        let count=0; // limit safety
        for(let d=new Date(start); d<=end && count<120; d.setDate(d.getDate()+1), count++){
          const iso=d.toISOString().slice(0,10);
          wrap.appendChild(renderDayChip(c, iso));
        }
        dailyTd.appendChild(wrap); tr.appendChild(dailyTd);
        // actions
        const actionTd=document.createElement('td'); actionTd.style.display='grid'; actionTd.style.gridTemplateColumns='repeat(2,1fr)'; actionTd.style.gap='0.2rem'; actionTd.style.justifyItems='center';
        const editBtn=document.createElement('button');
        editBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="14" height="12" rx="2" fill="#B5A89A"/><path d="m6 2v4m8-4v4" stroke="#2B2C29" stroke-width="2" stroke-linecap="round"/><path d="M3 8h14" stroke="#2B2C29" stroke-width="2"/><circle cx="8" cy="12" r="1" fill="#2B2C29"/><circle cx="12" cy="12" r="1" fill="#2B2C29"/></svg>';
        editBtn.title='Edit'; editBtn.style.background='none'; editBtn.style.border='none'; editBtn.style.cursor='pointer'; editBtn.style.padding='2px';
        editBtn.onclick=()=>{
          const s = prompt('Start date (YYYY-MM-DD):', c.startDate||''); if(s===null) return;
          const est = prompt('Estimated end date (YYYY-MM-DD):', c.estEndDate||''); if(est===null) return;
          const aend = prompt('Actual end date (optional YYYY-MM-DD):', c.endDate||''); if(aend===null) return;
          c.startDate=s; c.estEndDate=est; c.endDate=aend||''; saveHealthData(); renderPeriods();
        };
        const delBtn=document.createElement('button');
        delBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="8" width="8" height="8" rx="2" fill="#E07A5F"/><rect x="9" y="11" width="2" height="3" rx="1" fill="#fff"/><rect x="8" y="4" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
        delBtn.title='Delete'; delBtn.style.background='none'; delBtn.style.border='none'; delBtn.style.cursor='pointer'; delBtn.style.padding='2px';
        delBtn.onclick=()=>{ if(!confirm('Delete this period cycle?')) return; periodCycles = periodCycles.filter(x=>x.id!==c.id); saveHealthData(); renderPeriods(); };
        actionTd.appendChild(editBtn); actionTd.appendChild(delBtn);
        tr.appendChild(actionTd);
        table.appendChild(tr);
      });
      container.appendChild(table);
    }

    async function initHealth(){
      await loadHealthData();
      updateHealthTypeOptions();
      renderHealthNotes();
      renderPeriods();
    }

    document.addEventListener('DOMContentLoaded', initHealth);
  </script>

  <!-- Health: Period Tracker -->
  <section>
    <div class="toggle section-header" onclick="toggle('periodSection')">Period Tracker</div>
    <div id="periodSection" class="hidden">
      <div class="toggle add-toggle" onclick="toggle('addPeriodForm')">Add Period Start</div>
      <div id="addPeriodForm" class="hidden subtoggle form-grid">
        <label>Start Date<input type="date" id="periodStart"></label>
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addPeriod()">Submit</button>
        </div>
      </div>
      <div id="periodList"></div>
    </div>
  </section>

  <!-- Health: Health Notes -->
  <section>
    <div class="toggle section-header" onclick="toggle('healthNotesSection')">Health Notes</div>
    <div id="healthNotesSection" class="hidden">
      <div class="toggle add-toggle" onclick="toggle('addHealthTypeForm')">Add Health Type</div>
      <div id="addHealthTypeForm" class="hidden subtoggle form-grid">
        <label>New Health Type<input type="text" id="newHealthType" placeholder="e.g., Headache"></label>
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addHealthType()">Add</button>
        </div>
      </div>

      <div class="toggle add-toggle" onclick="toggle('addHealthNoteForm')">Add Health Note</div>
      <div id="addHealthNoteForm" class="hidden subtoggle form-grid">
        <label>Type
          <select id="hnType"></select>
        </label>
        <label>Start Date<input type="date" id="hnStart"></label>
        <label>Has Duration
          <select id="hnHasDuration" onchange="toggleHealthDuration()">
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </label>
        <div id="hnDurationFields" class="hidden" style="grid-column:1/-1;">
          <div class="form-grid">
            <label>End Date<input type="date" id="hnEnd"></label>
            <label>Intensity<input type="number" id="hnIntensity" min="0" max="10" placeholder="0-10"></label>
          </div>
        </div>
        <label style="grid-column:1/-1;">Notes<textarea id="hnNotes" rows="3"></textarea></label>
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addHealthNote()">Submit</button>
        </div>
      </div>
      <div id="healthNotesList"></div>
    </div>
  </section>

  <!-- Experience Tracker Section (kept) -->
  <section>
    <div class="toggle section-header" onclick="toggle('experienceTracker')">
      Experience Tracker
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('experienceTracker')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
    <div id="experienceTracker" class="hidden">
      <!-- Add this debug section -->
      <div style="margin-bottom: 1rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
        <strong>Debug:</strong>
        <button onclick="refreshExperiences()" class="submit-btn" style="padding:0.25rem 0.5rem;font-size:0.8rem;margin-left:0.5rem;">üîÑ Refresh</button>
        <button onclick="console.log('Experiences:', experiences)" class="submit-btn" style="padding:0.25rem 0.5rem;font-size:0.8rem;margin-left:0.25rem;">üìä Log Data</button>
      </div>
      
      <table class="notification-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>Next Trigger</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="experienceList">
          <!-- Experience notifications will be populated here -->
        </tbody>
      </table>
      
      <div class="toggle add-toggle" onclick="toggle('addExperience')">Add Experience Notification</div>
      <div id="addExperience" class="hidden subtoggle form-grid">
        <label>Name<input type="text" id="experienceName" placeholder="Experience name"></label>
        <label>Description<textarea id="experienceDescription" placeholder="Description of the experience" rows="3"></textarea></label>
        <label>Trigger Type<select id="triggerType" onchange="showTriggerOptions()">
          <option value="">Select trigger type</option>
          <option value="set">Set Time/Day</option>
          <option value="recurring">Recurring</option>
        </select></label>
        
        <!-- Set Time/Day Options -->
        <div id="setTimeOptions" class="hidden" style="grid-column: 1/-1;">
          <div class="form-grid">
            <label>Times of Day<input type="text" id="timesOfDay" placeholder="e.g., 09:00, 14:00, 20:00"></label>
            <label>Days of Week<select id="daysOfWeek" multiple>
              <option value="Mon">Monday</option>
              <option value="Tue">Tuesday</option>
              <option value="Wed">Wednesday</option>
              <option value="Thu">Thursday</option>
              <option value="Fri">Friday</option>
              <option value="Sat">Saturday</option>
              <option value="Sun">Sunday</option>
            </select></label>
          </div>
        </div>
        
        <!-- Recurring Options -->
        <div id="recurringOptions" class="hidden" style="grid-column: 1/-1;">
          <div class="form-grid">
            <label>Interval Number<input type="number" id="intervalNumber" min="1" placeholder="e.g., 5"></label>
            <label>Interval Type<select id="intervalType">
              <option value="minutes">Minutes</option>
              <option value="hours">Hours</option>
              <option value="days">Days</option>
            </select></label>
          </div>
        </div>
        
        <label>Response Type<select id="responseType" onchange="showResponseOptions()">
          <option value="">Select response type</option>
          <option value="1-2">1-2 Responses</option>
          <option value="more">More than 2 (Survey)</option>
        </select></label>
        
        <!-- Simple Responses -->
        <div id="simpleResponses" class="hidden" style="grid-column: 1/-1;">
          <label>Responses (comma separated)<input type="text" id="responseOptions" placeholder="e.g., Yes, No or 1, 2, 3, 4, 5"></label>
        </div>
        
        <!-- Survey Questions -->
        <div id="surveyQuestions" class="hidden" style="grid-column: 1/-1;">
          <h4>Survey Questions</h4>
          <div id="questionsList"></div>
          <button type="button" onclick="addQuestion()" class="submit-btn">+ Add Question</button>
        </div>
        
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addExperience()">Submit</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Settings Section (moved notification controls here) -->
  <section>
    <div class="toggle section-header" onclick="toggle('settings')">
      Settings
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('settings')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
    <div id="settings" class="hidden">
      <h3>Notification Controls</h3>
      <div class="surface">
        <h4>Experience Scheduler</h4>
        <p>Automated notifications run in the background on the server and will trigger experiences based on their schedules.</p>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-bottom: 1rem;">
          <button id="schedulerStatusBtn" class="submit-btn">Check Status</button>
          <button id="startSchedulerBtn" class="submit-btn">Start Scheduler</button>
          <button id="stopSchedulerBtn" class="submit-btn">Stop Scheduler</button>
        </div>
        <div style="font-size:0.85rem; color:#666; margin-bottom:1rem;">
          <strong>Start Scheduler:</strong> Begins automatic checking every 30 seconds for due experiences<br>
          <strong>Stop Scheduler:</strong> Pauses all automated notifications (manual triggers still work)
        </div>
        <div id="schedulerInfo" style="margin-bottom:1.5rem;font-size:.95rem;color:#666;"></div>
        
        <h4>Notification Pause Schedules</h4>
        <p>Set time periods when automated notifications should be paused (e.g., sleeping hours, meetings).</p>
        
        <table class="notification-table" style="margin-bottom:1rem;">
          <thead>
            <tr>
              <th>Name</th>
              <th>Days</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="pauseSchedulesList">
            <!-- Pause schedules will be populated here -->
          </tbody>
        </table>
        
        <div class="toggle add-toggle" onclick="toggle('addPauseSchedule')" style="margin-bottom:1rem;">Add Pause Schedule</div>
        <div id="addPauseSchedule" class="hidden subtoggle form-grid" style="margin-bottom:1.5rem;">
          <label>Schedule Name<input type="text" id="pauseName" placeholder="e.g., Sleep Hours, Work Meeting"></label>
          <label>Days of Week<select id="pauseDays" multiple>
            <option value="Mon">Monday</option>
            <option value="Tue">Tuesday</option>
            <option value="Wed">Wednesday</option>
            <option value="Thu">Thursday</option>
            <option value="Fri">Friday</option>
            <option value="Sat">Saturday</option>
            <option value="Sun">Sunday</option>
          </select></label>
          <label>Start Time<input type="time" id="pauseStartTime"></label>
          <label>End Time<input type="time" id="pauseEndTime"></label>
          <div style="grid-column:1/-1;text-align:center;">
            <button class="submit-btn" onclick="addPauseSchedule()">Add Pause Schedule</button>
          </div>
        </div>

        <h4>Authorized Devices</h4>
        <p>Devices that have granted notification permissions and are subscribed to push notifications.</p>
        <table class="notification-table" style="margin-bottom:1rem;">
          <thead>
            <tr>
              <th>Device Info</th>
              <th>Browser</th>
              <th>Subscribed</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="devicesList">
            <!-- Authorized devices will be populated here -->
          </tbody>
        </table>
        
        <h4>Desktop Notification Testing</h4>
        <p>Test notification functionality and manage browser permissions.</p>
        <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
          <button id="notifyBtn" class="submit-btn">Send Test Notification</button>
          <button id="requestPermBtn" class="submit-btn" title="Request browser permission">Request Permission</button>
          <button id="subscribePushBtn" class="submit-btn" title="Subscribe to push notifications">Subscribe to Push</button>
          <button onclick="resetPushSubscription()" class="submit-btn" style="background:#ff6b35;" title="Reset push subscription">üîÑ Reset Subscription</button>
          <button id="sendPushBtn" class="submit-btn" title="Send push notification to all subscribers">Send Push to All</button>
        </div>
        <div id="notifyStatus" class="text-muted" style="margin-top:.5rem;font-size:.95rem;"></div>
        <div id="notifyCounts" style="margin-top:.25rem;font-size:.95rem;"></div>
        <div id="pushInfo" style="margin-top:.25rem;font-size:.95rem;color:#666;"></div>
        <details style="margin-top:.5rem;">
          <summary>Diagnostics</summary>
          <pre id="notifyDiag" style="white-space:pre-wrap; background:#f7f7f7; padding:.5rem; border-radius:6px; border:1px solid #e0e0e0;">Loading‚Ä¶</pre>
        </details>
      </div>
    </div>
  </section>

  <!-- Survey Response Modal -->
  <div id="surveyModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="surveyTitle">Experience Survey</h3>
        <span class="close" onclick="closeSurveyModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="surveyContent"></div>
      </div>
      <div class="modal-footer">
        <button onclick="submitSurvey()" class="submit-btn">Submit</button>
        <button onclick="closeSurveyModal()" class="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Register a minimal service worker (for showNotification and future push)
    (function registerSW(){
      if ('serviceWorker' in navigator) {
        // Use absolute path so scope is the site root
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      }
    })();

// Global variables for experience tracker
let experiences = [];
let nextExperienceId = 1;
let pauseSchedules = [];
let nextPauseId = 1;
let deviceInfo = null;
let pendingOpenSurveyId = null;

// Helper functions for toggle and pin functionality
function toggle(id) {
  console.log('Toggle function called for:', id);
  const element = document.getElementById(id);
  console.log('Element found:', element);
  if (element) {
    element.classList.toggle('hidden');
    console.log('Hidden class toggled. Current classes:', element.classList.toString());
  } else {
    console.error('Element not found with id:', id);
  }
}

// Make sure toggle is available globally
window.toggle = toggle;

function togglePin(sectionId) {
  const pinStar = document.querySelector(`[onclick*="togglePin('${sectionId}')"]`);
  if (pinStar) {
    pinStar.classList.toggle('pinned');
    localStorage.setItem(`pin-${sectionId}`, pinStar.classList.contains('pinned') ? 'true' : 'false');
  }
}

function restorePins() {
  const sections = ['experienceTracker', 'settings'];
  sections.forEach(sectionId => {
    const isPinned = localStorage.getItem(`pin-${sectionId}`) === 'true';
    if (isPinned) {
      const pinStar = document.querySelector(`[onclick*="togglePin('${sectionId}')"]`);
      const section = document.getElementById(sectionId);
      if (pinStar && section) {
        pinStar.classList.add('pinned');
        section.classList.remove('hidden');
      }
    }
  });
}

// Helper to convert VAPID key
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
  const rawData = atob(base64);
  return new Uint8Array([...rawData].map(char => char.charCodeAt(0)));
}

// Main notification management functions
(function(){
  const statusEl = document.getElementById('notifyStatus');
  const diagEl = document.getElementById('notifyDiag');
  const pushInfoEl = document.getElementById('pushInfo');
  const schedulerInfoEl = document.getElementById('schedulerInfo');
  
  function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }
  function setDiag(obj){ if(diagEl) diagEl.textContent = JSON.stringify(obj, null, 2); }
  function setPushInfo(msg){ if(pushInfoEl) pushInfoEl.textContent = msg; }
  function setSchedulerInfo(msg){ if(schedulerInfoEl) schedulerInfoEl.textContent = msg; }

  // Push notification functions
  async function subscribeToPush() {
    try {
      setPushInfo('üì± Subscribing to push notifications...');
      
      const registration = await navigator.serviceWorker.ready;
      const vapidResponse = await fetch('/vapidPublicKey');
      const vapidPublicKey = await vapidResponse.text();
      
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
      });

      const response = await fetch("/subscribe", {
        method: "POST",
        body: JSON.stringify(subscription),
        headers: { "Content-Type": "application/json" }
      });

      const result = await response.json();
      setPushInfo(`‚úÖ Subscribed to push notifications! (${result.total} total subscribers)`);
      updateDeviceRegistration();
      checkSchedulerStatus();
      
    } catch (error) {
      console.error('Push subscription failed:', error);
      if (error.message.includes('different application')) {
        setPushInfo('‚ö†Ô∏è Existing subscription conflict detected. Use "üîÑ Reset Subscription" to fix this.');
      } else {
        setPushInfo('‚ùå Failed to subscribe: ' + error.message);
      }
    }
  }

  async function resetPushSubscription() {
    try {
      setPushInfo('üîÑ Resetting push subscription...');
      
      const registration = await navigator.serviceWorker.ready;
      const existingSubscription = await registration.pushManager.getSubscription();
      
      if (existingSubscription) {
        console.log('üì§ Unsubscribing from existing subscription...');
        
        await fetch("/unsubscribe", {
          method: "POST",
          body: JSON.stringify({ endpoint: existingSubscription.endpoint }),
          headers: { "Content-Type": "application/json" }
        });
        
        await existingSubscription.unsubscribe();
        setPushInfo('‚úÖ Unsubscribed from existing subscription');
      }
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      console.log('üì• Creating new subscription...');
      const vapidResponse = await fetch('/vapidPublicKey');
      const vapidPublicKey = await vapidResponse.text();
      
      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
      });
      
      const response = await fetch("/subscribe", {
        method: "POST",
        body: JSON.stringify(subscription),
        headers: { "Content-Type": "application/json" }
      });
      
      const result = await response.json();
      setPushInfo(`‚úÖ Successfully subscribed! (${result.total} total subscribers)`);
      updateDeviceRegistration();
      checkSchedulerStatus();
      
    } catch (error) {
      console.error('Reset subscription failed:', error);
      setPushInfo('‚ùå Failed to reset subscription: ' + error.message);
    }
  }

  // Scheduler control functions
  async function checkSchedulerStatus() {
    try {
      const response = await fetch('/api/scheduler/status');
      const data = await response.json();
      const status = data.running ? 'RUNNING' : 'STOPPED';
      setSchedulerInfo(`Scheduler: ${status} | Subscribers: ${data.subscriberCount} | Check interval: ${data.checkInterval}`);
    } catch (error) {
      setSchedulerInfo('Failed to get scheduler status: ' + error.message);
    }
  }

  async function startScheduler() {
    try {
      const response = await fetch('/api/scheduler/start', { method: 'POST' });
      const data = await response.json();
      setSchedulerInfo(data.message);
      setTimeout(checkSchedulerStatus, 1000);
    } catch (error) {
      setSchedulerInfo('Failed to start scheduler: ' + error.message);
    }
  }

  async function stopScheduler() {
    try {
      const response = await fetch('/api/scheduler/stop', { method: 'POST' });
      const data = await response.json();
      setSchedulerInfo(data.message);
      setTimeout(checkSchedulerStatus, 1000);
    } catch (error) {
      setSchedulerInfo('Failed to stop scheduler: ' + error.message);
    }
  }

  // Device management functions
  function getDeviceInfo() {
    const ua = navigator.userAgent;
    const platform = navigator.platform;
    const language = navigator.language;
    
    let browser = 'Unknown';
    if (ua.includes('Chrome')) browser = 'Chrome';
    else if (ua.includes('Firefox')) browser = 'Firefox';
    else if (ua.includes('Safari')) browser = 'Safari';
    else if (ua.includes('Edge')) browser = 'Edge';
    
    let os = 'Unknown';
    if (platform.includes('Win')) os = 'Windows';
    else if (platform.includes('Mac')) os = 'macOS';
    else if (platform.includes('Linux')) os = 'Linux';
    else if (ua.includes('Android')) os = 'Android';
    else if (ua.includes('iPhone') || ua.includes('iPad')) os = 'iOS';

    return {
      browser,
      os,
      platform,
      language,
      userAgent: ua,
      timestamp: new Date().toISOString()
    };
  }

  async function updateDeviceRegistration() {
    try {
      deviceInfo = getDeviceInfo();
      
      let pushSubscribed = false;
      if (navigator.serviceWorker) {
        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration && registration.pushManager) {
            const subscription = await registration.pushManager.getSubscription();
            pushSubscribed = !!subscription;
          }
        } catch (error) {
          console.error('Error checking push subscription:', error);
        }
      }

      deviceInfo.pushSubscribed = pushSubscribed;
      deviceInfo.notificationPermission = ('Notification' in window) ? Notification.permission : 'unsupported';
      
      const deviceId = deviceInfo.userAgent.slice(0, 50) + '_' + deviceInfo.platform;
      const devices = JSON.parse(localStorage.getItem('authorizedDevices') || '{}');
      devices[deviceId] = deviceInfo;
      localStorage.setItem('authorizedDevices', JSON.stringify(devices));
      
      renderDevices();
    } catch (error) {
      console.error('Failed to update device registration:', error);
    }
  }

  function renderDevices() {
    const tbody = document.getElementById('devicesList');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    try {
      const devices = JSON.parse(localStorage.getItem('authorizedDevices') || '{}');
      const deviceEntries = Object.entries(devices);
      
      if (deviceEntries.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" style="text-align:center;color:#666;">No devices registered</td>';
        tbody.appendChild(row);
        return;
      }

      deviceEntries.forEach(([deviceId, device]) => {
        const row = document.createElement('tr');
        const isCurrentDevice = deviceId.includes(navigator.userAgent.slice(0, 20));
        const deviceName = `${device.os} - ${device.browser}` + (isCurrentDevice ? ' (This Device)' : '');
        const subscriptionStatus = device.pushSubscribed ? '‚úÖ Yes' : '‚ùå No';
        const lastSeen = new Date(device.timestamp).toLocaleString();
        
        row.innerHTML = `
          <td>${deviceName}</td>
          <td>${device.browser} (${device.language})</td>
          <td>${subscriptionStatus}</td>
          <td>${lastSeen}</td>
          <td>
            <button onclick="removeDevice('${deviceId}')" class="submit-btn" style="padding:0.25rem 0.5rem;font-size:0.8rem;background:#dc3545;" ${isCurrentDevice ? 'disabled' : ''}>Remove</button>
          </td>
        `;
        
        if (isCurrentDevice) {
          row.style.backgroundColor = '#f8f9fa';
        }
        
        tbody.appendChild(row);
      });
    } catch (error) {
      console.error('Error rendering devices:', error);
    }
  }

  // Expose selected functions used outside this IIFE
  window.subscribeToPush = subscribeToPush;
  window.resetPushSubscription = resetPushSubscription;
  window.checkSchedulerStatus = checkSchedulerStatus;
  window.startScheduler = startScheduler;
  window.stopScheduler = stopScheduler;
  window.updateDeviceRegistration = updateDeviceRegistration;
})();

  // Add these missing functions to your script section

// First, make sure we have all the DOM manipulation functions
function removeDevice(deviceId) {
  try {
    const devices = JSON.parse(localStorage.getItem('authorizedDevices') || '{}');
    delete devices[deviceId];
    localStorage.setItem('authorizedDevices', JSON.stringify(devices));
    renderDevices(); // Re-render the table
  } catch (error) {
    console.error('Failed to remove device:', error);
  }
}

// Fix the loadExperiences function to handle the API response properly
async function loadExperiences() {
  try {
    console.log('üîÑ Loading experiences from server...');
    const response = await fetch('/api/experiences');
    
    if (!response.ok) {
      throw new Error(`Server responded with ${response.status}: ${await response.text()}`);
    }
    
    const data = await response.json();
    console.log('üìä Loaded experience data:', data);
    
    // Handle both possible response formats
    if (data.experiences) {
      experiences = data.experiences;
      nextExperienceId = data.nextExperienceId || 1;
    } else if (Array.isArray(data)) {
      experiences = data;
    } else {
      console.error('Unexpected data format:', data);
      experiences = [];
    }
    
    console.log(`üìã Found ${experiences.length} experiences`);
    renderExperiences();
  // If we were asked to open a survey (from SW message or URL), try now
  tryOpenPendingSurvey();
    
  } catch (error) {
    console.error('‚ùå Failed to load experiences:', error);
    
    // Show user-friendly error
    const tbody = document.getElementById('experienceList');
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:red;">Failed to load experiences: ${error.message}</td></tr>`;
    }
  }
}

// Fix the renderExperiences function
function renderExperiences() {
  const tbody = document.getElementById('experienceList');
  if (!tbody) {
    console.error('‚ùå experienceList table body not found');
    return;
  }
  
  console.log(`üé® Rendering ${experiences.length} experiences`);
  tbody.innerHTML = '';
  
  if (experiences.length === 0) {
    const row = document.createElement('tr');
    row.innerHTML = '<td colspan="5" style="text-align:center;color:#666;">No experiences created yet. Click "Add Experience Notification" to create one.</td>';
    tbody.appendChild(row);
    return;
  }
  
  experiences.forEach((experience, index) => {
    console.log(`üìù Rendering experience ${index + 1}:`, experience.name);
    
    const row = document.createElement('tr');
    
    // Build trigger description
    let triggerText = '';
    if (experience.triggerType === 'recurring') {
      triggerText = `Every ${experience.intervalNumber} ${experience.intervalType}`;
    } else if (experience.triggerType === 'set') {
      triggerText = `${experience.timesOfDay?.join(', ')} on ${experience.daysOfWeek?.join(', ')}`;
    } else {
      triggerText = 'Unknown trigger type';
    }
    
    // Format next trigger time
    const nextTrigger = experience.nextTrigger 
      ? new Date(experience.nextTrigger).toLocaleString()
      : 'Not scheduled';
    
    // Status badge
    let statusBadge = '';
    if (experience.status !== 'active') {
      statusBadge = '<span style="color:orange;font-weight:bold;">‚óè</span> Paused';
    } else if (experience.pendingResponse) {
      statusBadge = '<span style="color:#ffc107;font-weight:bold;">‚óè</span> Waiting';
    } else {
      statusBadge = '<span style="color:green;font-weight:bold;">‚óè</span> Active';
    }
    
    row.innerHTML = `
      <td><strong>${experience.name}</strong><br><small style="color:#666;">${experience.description}</small></td>
      <td>${triggerText}</td>
      <td>${statusBadge}</td>
      <td>${nextTrigger}</td>
      <td style="text-align: center;">
        <button onclick="triggerExperience(${experience.id})" title="Trigger Now" style="background: none; border: none; cursor: pointer; padding: 4px; margin: 0 2px;">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" fill="#28a745"/>
            <polygon points="8,6 8,14 14,10" fill="white"/>
          </svg>
        </button>
        ${experience.pendingResponse ? `<button onclick="respondToExperience(${experience.id})" title="Respond" style="background: none; border: none; cursor: pointer; padding: 4px; margin: 0 2px;">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="10" cy="10" r="8" fill="#17a2b8"/>
            <path d="M6 10l2 2 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>` : ''}
        <button onclick="toggleExperienceStatus(${experience.id})" title="${experience.status === 'active' ? 'Pause' : 'Resume'}" style="background: none; border: none; cursor: pointer; padding: 4px; margin: 0 2px;">
          ${experience.status === 'active' ? 
            `<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="10" r="8" fill="#ffc107"/>
              <rect x="7" y="6" width="2" height="8" fill="white"/>
              <rect x="11" y="6" width="2" height="8" fill="white"/>
            </svg>` : 
            `<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="10" cy="10" r="8" fill="#28a745"/>
              <polygon points="8,6 8,14 14,10" fill="white"/>
            </svg>`
          }
        </button>
        <button onclick="deleteExperience(${experience.id})" title="Delete" style="background: none; border: none; cursor: pointer; padding: 4px; margin: 0 2px;">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8.5 2C7.11929 2 6 3.11929 6 4.5H4C3.44772 4.5 3 4.94772 3 5.5C3 6.05228 3.44772 6.5 4 6.5H16C16.5523 6.5 17 6.05228 17 5.5C17 4.94772 16.5523 4.5 16 4.5H14C14 3.11929 12.8807 2 11.5 2H8.5Z" fill="#dc3545"/>
            <path d="M5 8.5C5 7.94772 5.44772 7.5 6 7.5H14C14.5523 7.5 15 7.94772 15 8.5V16C15 17.1046 14.1046 18 13 18H7C5.89543 18 5 17.1046 5 16V8.5Z" fill="#ff6b6b"/>
          </svg>
        </button>
      </td>
    `;
    
    tbody.appendChild(row);
  });
}

// Fix the manual trigger function
async function triggerExperience(experienceId) {
  try {
    console.log('üî• Manually triggering experience:', experienceId);
    
    const experience = experiences.find(exp => exp.id === experienceId);
    if (!experience) {
      alert('Experience not found');
      return;
    }
    
    // Trigger the experience directly via the notification system
  if (experience.responseType === '1-2') {
      // Simple notification with action buttons
      await showSimpleNotification(
        experience.name,
        experience.description,
        experience.responses || ['Yes', 'No'],
        `experience-${experienceId}`
      );
    } else if (experience.responseType === 'more') {
      // Survey modal
      showSurveyModal(experience);
    }
    
    // Also notify server (uses the correct manual trigger endpoint)
    let response, text;
    try {
      response = await fetch(`/api/trigger-experience/${experienceId}`, { method: 'POST' });
      if (!response.ok) {
        try { text = await response.text(); } catch {}
        throw new Error(text || `Server responded ${response.status}`);
      }
      console.log('‚úÖ Experience trigger request sent to server');
    } catch (e) {
      console.warn('Server manual trigger request failed:', e);
    }
    await loadExperiences();
    
  } catch (error) {
    console.error('‚ùå Failed to trigger experience:', error);
    alert('Failed to trigger experience: ' + error.message);
  }
}
function respondToExperience(id) {
  const exp = experiences.find(e => e.id === id);
  if (!exp) return;
  if (exp.responseType === 'more') {
    showSurveyModal(exp);
  } else {
    showSimpleNotification(exp.name, exp.description, exp.responses || ['Yes','No'], `experience-${id}`);
  }
}
window.respondToExperience = respondToExperience;

// Make sure the page loads experiences when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Page loaded, initializing experience tracker...');
  
  // Load experiences after a short delay to ensure all elements are ready
  setTimeout(() => {
    loadExperiences();
  }, 500);
  
  // Also load other components
  updateDeviceRegistration();
  checkSchedulerStatus();
  restorePins();
  
  // Expose functions to global scope
  window.removeDevice = removeDevice;
  window.loadExperiences = loadExperiences;
  window.renderExperiences = renderExperiences;
  if (typeof showTriggerOptions === 'function') window.showTriggerOptions = showTriggerOptions;
  if (typeof showResponseOptions === 'function') window.showResponseOptions = showResponseOptions;
  if (typeof addQuestion === 'function') window.addQuestion = addQuestion;
  if (typeof removeQuestion === 'function') window.removeQuestion = removeQuestion;
  if (typeof addExperience === 'function') window.addExperience = addExperience;
  window.triggerExperience = triggerExperience;
  if (typeof toggleExperienceStatus === 'function') window.toggleExperienceStatus = toggleExperienceStatus;
  if (typeof deleteExperience === 'function') window.deleteExperience = deleteExperience;

  // Wire up controls
  const notifyBtn = document.getElementById('notifyBtn');
  if (notifyBtn) notifyBtn.addEventListener('click', () => {
    showSimpleNotification('Test Notification', 'This is a desktop notification test', ['Yes', 'No'], 'test');
  });
  const requestPermBtn = document.getElementById('requestPermBtn');
  if (requestPermBtn) requestPermBtn.addEventListener('click', async () => {
    try {
      const result = await Notification.requestPermission();
      const el = document.getElementById('notifyStatus');
      if (el) el.textContent = `Permission: ${result}`;
    } catch {}
  });
  const subscribePushBtn = document.getElementById('subscribePushBtn');
  if (subscribePushBtn) subscribePushBtn.addEventListener('click', () => {
    if (typeof subscribeToPush === 'function') subscribeToPush();
  });
  const sendPushBtn = document.getElementById('sendPushBtn');
  if (sendPushBtn) sendPushBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('/send-push', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: 'Test Push', body: 'Hello from ToDo', data: { source: 'notification.html' } }) });
      const data = await res.json().catch(()=>({}));
      const pushInfo = document.getElementById('pushInfo');
      if (pushInfo) pushInfo.textContent = data.message || 'Push requested';
    } catch (e) {
      const pushInfo = document.getElementById('pushInfo');
      if (pushInfo) pushInfo.textContent = 'Failed to send push';
    }
  });
  const startSchedulerBtn = document.getElementById('startSchedulerBtn');
  if (startSchedulerBtn) startSchedulerBtn.addEventListener('click', () => { if (typeof startScheduler === 'function') startScheduler(); });
  const stopSchedulerBtn = document.getElementById('stopSchedulerBtn');
  if (stopSchedulerBtn) stopSchedulerBtn.addEventListener('click', () => { if (typeof stopScheduler === 'function') stopScheduler(); });
  const schedulerStatusBtn = document.getElementById('schedulerStatusBtn');
  if (schedulerStatusBtn) schedulerStatusBtn.addEventListener('click', () => { if (typeof checkSchedulerStatus === 'function') checkSchedulerStatus(); });

  // Listen for SW messages to open survey
  if (navigator.serviceWorker && navigator.serviceWorker.addEventListener) {
    navigator.serviceWorker.addEventListener('message', (event) => {
      const msg = event.data || {};
      if (msg.type === 'OPEN_SURVEY' && msg.experienceId) {
        pendingOpenSurveyId = Number(msg.experienceId);
        tryOpenPendingSurvey();
      }
    });
  }

  // If page opened with ?openSurvey=ID, handle it
  try {
    const params = new URLSearchParams(location.search);
    const id = params.get('openSurvey');
    if (id) {
      pendingOpenSurveyId = Number(id);
      tryOpenPendingSurvey();
    }
  } catch {}
});

// Also add a manual refresh button for debugging
function refreshExperiences() {
  console.log('üîÑ Manual refresh requested');
  loadExperiences();
}

window.refreshExperiences = refreshExperiences;

function tryOpenPendingSurvey() {
  if (!pendingOpenSurveyId) return;
  if (!Array.isArray(experiences) || experiences.length === 0) return; // wait until loaded
  const exp = experiences.find(e => Number(e.id) === Number(pendingOpenSurveyId));
  if (!exp) return;
  if (exp.responseType === 'more') {
    showSurveyModal(exp);
  }
  pendingOpenSurveyId = null;
}

// --- Client notification helpers ---
async function showSimpleNotification(title, body, responses = ['Yes', 'No'], tag = 'simple') {
  try {
    if (!('Notification' in window)) {
      alert(`${title}\n\n${body}`);
      return;
    }
    if (Notification.permission === 'default') {
      await Notification.requestPermission();
    }
    if (Notification.permission !== 'granted') {
      alert(`${title}\n\n${body}`);
      return;
    }
    const registration = await navigator.serviceWorker.ready;
    const actions = (responses || []).slice(0, 2).map((r, i) => ({ action: `resp-${i}`, title: r }));
    await registration.showNotification(title, {
      body,
      tag,
      requireInteraction: true,
      icon: '/favicon.ico',
      badge: '/favicon.ico',
      actions
    });
  } catch (err) {
    console.error('showSimpleNotification failed:', err);
    alert(`${title}\n\n${body}`);
  }
}
// expose for inline use if needed
window.showSimpleNotification = showSimpleNotification;

let currentSurveyExperience = null;
function showSurveyModal(experience) {
  currentSurveyExperience = experience;
  const modal = document.getElementById('surveyModal');
  const titleEl = document.getElementById('surveyTitle');
  const contentEl = document.getElementById('surveyContent');
  if (!modal || !titleEl || !contentEl) return;
  titleEl.textContent = experience.name || 'Experience Survey';
  // Build a simple form based on experience.questions (if present)
  const questions = experience.questions || [];
  if (questions.length === 0) {
    contentEl.innerHTML = `<p>${experience.description || 'Please provide your input.'}</p>`;
  } else {
    const html = questions.map((q, idx) => {
      const safeText = q.text || `Question ${idx + 1}`;
      if (q.type === 'text') {
        return `
          <div class="survey-question">
            <div class="survey-q-text">${safeText}</div>
            <input type="text" class="survey-input" data-q-index="${idx}" placeholder="Type your answer" />
          </div>
        `;
      }
      const buttons = (q.options || []).map(opt => `
        <button type="button" class="btn btn-outline option-btn" data-q-index="${idx}" data-value="${opt.replace(/&/g,'&amp;').replace(/</g,'&lt;')}" onclick="selectSurveyOption(${idx}, '${opt.replace(/'/g,"\\'")}', this)">${opt}</button>
      `).join('');
      return `
        <div class="survey-question">
          <div class="survey-q-text">${safeText}</div>
          <div class="survey-options">${buttons}</div>
        </div>
      `;
    }).join('');
    contentEl.innerHTML = html;
  }
  modal.classList.remove('hidden');
  modal.style.display = 'block';
}
window.showSurveyModal = showSurveyModal;

function closeSurveyModal() {
  const modal = document.getElementById('surveyModal');
  if (modal) {
    modal.style.display = 'none';
    modal.classList.add('hidden');
  }
  currentSurveyExperience = null;
}
window.closeSurveyModal = closeSurveyModal;

async function submitSurvey() {
  try {
    if (!currentSurveyExperience) { closeSurveyModal(); return; }
    const contentEl = document.getElementById('surveyContent');
    const answers = [];
    const questions = currentSurveyExperience.questions || [];
    questions.forEach((q, idx) => {
      if (q.type === 'text') {
        const input = contentEl.querySelector(`.survey-input[data-q-index="${idx}"]`);
        answers.push({ questionIndex: idx, value: (input && input.value) || '' });
      } else {
        // find selected option button
  const selected = contentEl.querySelector(`.option-btn.selected[data-q-index="${idx}"]`) || contentEl.querySelector(`.option-btn[data-q-index="${idx}"][aria-pressed="true"]`);
        const value = selected ? selected.getAttribute('data-value') : '';
        answers.push({ questionIndex: idx, value });
      }
    });
    await fetch('/api/experience-responses', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ experienceId: currentSurveyExperience.id, answers })
    });
    closeSurveyModal();
  } catch (err) {
    console.error('submitSurvey failed:', err);
    closeSurveyModal();
  }
}
window.submitSurvey = submitSurvey;

// Single-choice selector for survey options
function selectSurveyOption(qIndex, value, btn) {
  try {
    const container = btn && btn.parentElement;
    if (!container) return;
    const siblings = container.querySelectorAll(`.option-btn[data-q-index="${qIndex}"]`);
    siblings.forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
    btn.classList.add('selected');
    btn.setAttribute('aria-pressed','true');
  } catch (e) { /* ignore */ }
}
window.selectSurveyOption = selectSurveyOption;

// --- Form toggles and creation ---
function showTriggerOptions() {
  const type = (document.getElementById('triggerType') || {}).value || '';
  const setBlock = document.getElementById('setTimeOptions');
  const recBlock = document.getElementById('recurringOptions');
  if (setBlock) setBlock.classList.toggle('hidden', type !== 'set');
  if (recBlock) recBlock.classList.toggle('hidden', type !== 'recurring');
}

function showResponseOptions() {
  const type = (document.getElementById('responseType') || {}).value || '';
  const simple = document.getElementById('simpleResponses');
  const survey = document.getElementById('surveyQuestions');
  if (simple) simple.classList.toggle('hidden', type !== '1-2');
  if (survey) survey.classList.toggle('hidden', type !== 'more');
}

function addQuestion() {
  const container = document.getElementById('questionsList');
  if (!container) return;
  const id = 'q_' + Date.now();
  const div = document.createElement('div');
  div.className = 'question-item';
  div.dataset.qid = id;
  div.innerHTML = `
    <button type="button" onclick="removeQuestion(this.parentElement)" title="Remove">‚úñ</button>
    <label>Question Text<input type="text" name="questionText" placeholder="e.g., How do you feel?" /></label>
    <label>Question Type<select name="questionType">
      <option value="select">Multiple Choice</option>
      <option value="text">Free Text</option>
    </select></label>
    <label>Options (comma separated)<input type="text" name="questionOptions" placeholder="Yes, No, Maybe" /></label>
  `;
  container.appendChild(div);
}

function removeQuestion(el) {
  if (!el) return;
  try { el.remove(); } catch {}
}

function calculateNextRecurringTrigger(intervalNumber, intervalType) {
  const now = new Date();
  const next = new Date(now);
  if (intervalType === 'minutes') next.setMinutes(now.getMinutes() + Number(intervalNumber || 1));
  else if (intervalType === 'hours') next.setHours(now.getHours() + Number(intervalNumber || 1));
  else if (intervalType === 'days') next.setDate(now.getDate() + Number(intervalNumber || 1));
  return next.toISOString();
}

function calculateNextSetTrigger(timesOfDay = [], daysOfWeek = []) {
  const now = new Date();
  let best = null;
  for (let i = 0; i < 7; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() + i);
    const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d.getDay()];
    if (!daysOfWeek.includes(dayName)) continue;
    for (const t of timesOfDay) {
      const [hh, mm] = (t || '').split(':').map(Number);
      if (Number.isFinite(hh) && Number.isFinite(mm)) {
        const cand = new Date(d);
        cand.setHours(hh, mm, 0, 0);
        if (cand > now && (!best || cand < best)) best = cand;
      }
    }
  }
  return best ? best.toISOString() : null;
}

async function addExperience() {
  try {
    const name = (document.getElementById('experienceName') || {}).value || '';
    const description = (document.getElementById('experienceDescription') || {}).value || '';
    const triggerType = (document.getElementById('triggerType') || {}).value || '';
    const responseType = (document.getElementById('responseType') || {}).value || '';

    if (!name || !triggerType || !responseType) {
      alert('Please fill in Name, Trigger Type, and Response Type.');
      return;
    }

    const exp = { name, description, triggerType, responseType, status: 'active' };
    if (triggerType === 'recurring') {
      const intervalNumber = Number((document.getElementById('intervalNumber') || {}).value || 1);
      const intervalType = (document.getElementById('intervalType') || {}).value || 'minutes';
      Object.assign(exp, { intervalNumber, intervalType });
      exp.nextTrigger = calculateNextRecurringTrigger(intervalNumber, intervalType);
    } else if (triggerType === 'set') {
      const times = ((document.getElementById('timesOfDay') || {}).value || '')
        .split(',').map(s => s.trim()).filter(Boolean);
      const daysSelect = document.getElementById('daysOfWeek');
      const days = daysSelect ? Array.from(daysSelect.selectedOptions).map(o => o.value) : [];
      Object.assign(exp, { timesOfDay: times, daysOfWeek: days });
      exp.nextTrigger = calculateNextSetTrigger(times, days);
    }

    if (responseType === '1-2') {
      const responsesStr = (document.getElementById('responseOptions') || {}).value || '';
      exp.responses = responsesStr.split(',').map(s => s.trim()).filter(Boolean).slice(0, 2);
    } else {
      const questions = [];
      const nodes = document.querySelectorAll('#surveyQuestions .question-item');
      nodes.forEach(node => {
        const text = (node.querySelector('input[name="questionText"]') || {}).value || '';
        const type = (node.querySelector('select[name="questionType"]') || {}).value || 'select';
        const optsStr = (node.querySelector('input[name="questionOptions"]') || {}).value || '';
        const options = optsStr.split(',').map(s => s.trim()).filter(Boolean);
        questions.push({ text, type, options });
      });
      exp.questions = questions;
    }

    const resp = await fetch('/api/experiences', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(exp)
    });
    if (!resp.ok) throw new Error(`Server responded ${resp.status}`);
    await loadExperiences();
    toggle('addExperience');
  } catch (err) {
    console.error('addExperience failed:', err);
    alert('Failed to add experience: ' + err.message);
  }
}

async function toggleExperienceStatus(id) {
  try {
    const exp = experiences.find(e => e.id === id);
    if (!exp) return;
    const newStatus = exp.status === 'active' ? 'paused' : 'active';
    let nextTrigger = exp.nextTrigger;
    if (newStatus === 'paused') nextTrigger = null;
    if (newStatus === 'active') {
      if (exp.triggerType === 'recurring') nextTrigger = calculateNextRecurringTrigger(exp.intervalNumber, exp.intervalType);
      if (exp.triggerType === 'set') nextTrigger = calculateNextSetTrigger(exp.timesOfDay || [], exp.daysOfWeek || []);
    }
    const resp = await fetch(`/api/experiences/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus, nextTrigger })
    });
    if (!resp.ok) throw new Error(`Server responded ${resp.status}`);
    await loadExperiences();
  } catch (err) {
    console.error('toggleExperienceStatus failed:', err);
    alert('Failed to update status: ' + err.message);
  }
}

async function deleteExperience(id) {
  try {
    const resp = await fetch(`/api/experiences/${id}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error(`Server responded ${resp.status}`);
    await loadExperiences();
  } catch (err) {
    console.error('deleteExperience failed:', err);
    alert('Failed to delete: ' + err.message);
  }
}
  </script>
  
  <style>
    /* Modal Styles aligned with site theme */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.35);
    }
    .modal-content {
      background: var(--color-header-bg);
      color: var(--color-header-text);
      margin: 5% auto;
      padding: 20px;
      border: 1px solid var(--color-border);
      width: 90%;
      max-width: 600px;
      border-radius: var(--radius-sm);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h3 {
      margin: 0;
      color: var(--color-header-text);
    }
    .close {
      color: var(--color-header-text);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: var(--color-header-text);
    }
    .modal-body {
      margin-bottom: 20px;
    }
    .modal-footer {
      text-align: right;
    }
    .cancel-btn {
      background: transparent;
      color: var(--color-header-text);
      border: 1px solid var(--color-header-text);
      padding: 0.6rem 1.2rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-left: 0.5rem;
    }
    .cancel-btn:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Survey styling */
  .survey-question { margin-bottom: 1.5rem; }
  .survey-q-text { font-weight: 600; margin-bottom: 0.6rem; font-size: 1.1rem; }
  .survey-options { display: flex; flex-wrap: wrap; gap: 0.2rem 0.4rem; align-items: center; }
  .option-btn { padding: 0.35rem 0.75rem; border-radius: var(--radius-pill); background: transparent; color: var(--color-header-text); border: 1px solid var(--color-header-text); font-size: 0.95rem; }
    .option-btn:hover { background: var(--color-header-text); color: var(--color-header-bg); }
    .option-btn.selected { background: var(--color-header-text); color: var(--color-header-bg); border: 1px solid var(--color-header-text); }
    /* comma separators between option buttons */
    .survey-options .option-btn::after { content: ","; color: var(--color-header-text); margin: 0 .25rem 0 .35rem; }
    .survey-options .option-btn:last-child::after { content: ""; }
    .survey-input { width: 100%; padding: 0.5rem; border:1px solid var(--color-header-text); border-radius: var(--radius-sm); background: transparent; color: var(--color-header-text); }
    .survey-input::placeholder { color: rgba(231,228,214,0.75); }

    /* Primary submit button in dark modal */
    .modal .submit-btn { background: var(--color-header-text); color: var(--color-header-bg); }
    .modal .submit-btn:hover { filter: brightness(0.92); }
  </style>
</body>
</html>
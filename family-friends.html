<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Family/Friends</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { margin:0; padding:0; }
    section { padding:1rem; }
    .hidden { display:none !important; }
    .inline-form { display:flex; gap:0.5rem; flex-wrap:wrap; align-items:end; }
    .inline-form label { display:flex; flex-direction:column; font-size:0.9rem; }
    .inline-form input[type="text"], .inline-form input[type="color"] { padding:0.35rem; font-size:1rem; }
    table.task-table { width:100%; border-collapse:collapse; margin-top:0.75rem; }
    .task-table th, .task-table td { border:1px solid #e2e5e9; padding:0.5rem; text-align:left; }
    .task-table th { background:#C7BBB4; color:#2B2C29; }
    .color-swatch { display:inline-block; width:18px; height:18px; border-radius:50%; border:1px solid #999; vertical-align:middle; margin-right:6px; }

    /* Match Index page banner (toggle) look */
    .toggle {
      cursor: pointer;
      background: #C7BBB4;
      padding: 0.5rem;
      border-radius: 4px;
      margin: 1rem 0;
      text-align: center;
    }

    .add-toggle { background:#2B2C29; color:#C7BBB4; font-size:0.8rem; padding:0.5rem; transition:all 0.2s ease; }
    .add-toggle:hover { background:#C7BBB4; color:#2B2C29; box-shadow:0 0 12px 2px #2B2C29; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:1rem; align-items:center; }
    .form-grid label { display:flex; flex-direction:column; font-size:0.9rem; font-weight:bold; }
    .form-grid input, .form-grid select, .form-grid textarea { width:100%; font-size:1rem; padding:0.4rem; margin-top:0.3rem; box-sizing:border-box; font-weight:normal; }
    .subtoggle { font-size:0.9rem; margin-top:0.5rem; }
    /* Match Index page section header typography */
    .section-header { position:relative; font-size:1.2rem; font-weight:bold; text-align:center; }
    .section-header .pin-star { position:absolute; top:50%; right:8px; transform:translateY(-50%); cursor:pointer; z-index:10; }
    .section-header .pin-star svg { width:16px; height:16px; }
    .section-header .pin-star.pinned svg { fill:#F7F6F3; stroke:#2B2C29; stroke-width:1; }

    /* Match Index page submit button styling */
    .submit-btn {
      background: #C7BBB4;
      color: #2B2C29;
      border: none;
      border-radius: 12px;
      padding: 0.7rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      box-shadow: 0 1px 2px rgba(44,44,44,0.04);
      transition: box-shadow 0.18s, background 0.18s, color 0.18s;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .submit-btn:hover {
      box-shadow: 0 0 12px 2px #2B2C29;
      background: #B5A89A;
      color: #E7E4D6;
    }

    /* Modal styles */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(43,44,41,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .modal-content{background:#fff;padding:1rem;border-radius:8px;max-width:90%;width:400px;}
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .modal-header h3 { margin:0; }
    .close { cursor:pointer; font-size:1.5rem; }
    .modal-body { margin-bottom:1rem; }
    .modal-footer { display:flex; gap:0.5rem; justify-content:flex-end; }
    .cancel-btn { background:#ccc; color:#333; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer; }
    .btn { background:#C7BBB4; color:#2B2C29; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer; }
    .btn-outline { background:none; border:1px solid #C7BBB4; color:#2B2C29; padding:0.3rem 0.6rem; border-radius:4px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>Family/Friends</h1>
  </header>
  <div id="nav-placeholder"></div>
  <script src="nav-loader.js"></script>
  <script>
  // Timer fallback to prevent early calls from crashing
  (function(){
    try{
      if(typeof window.createTimerButton!=="function"){
        window.createTimerButton=function(source,name){
          const btn=document.createElement('button');
          btn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" stroke="#2B2C29" stroke-width="2" fill="#C7BBB4"/><path d="M10 5v5l3 3" stroke="#2B2C29" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          btn.title='Start timer';
          btn.style.background='none';
          btn.style.border='none';
          btn.style.cursor='pointer';
          btn.addEventListener('click',()=>{
            if(typeof window.startTask==='function') window.startTask(source,name);
            else console.warn('[time-tracker] startTask not ready yet');
          });
          return btn;
        };
      }
      if(typeof window.startTask!=="function"){ window.startTask=function(){ console.warn('[time-tracker] startTask not ready yet'); }; }
      if(typeof window.stopTask!=="function"){ window.stopTask=function(){ console.warn('[time-tracker] stopTask not ready yet'); }; }
    }catch(e){}
  })();
  </script>

  <section>
    <div class="toggle section-header" onclick="toggle('birthdaysSection')">
      Birthdays
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('birthdaysSection')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
    <div id="birthdaysSection" class="hidden">
      <div id="birthdaysList"></div>
      <div class="toggle add-toggle" onclick="toggle('addBirthdayForm')">Add Birthday</div>
      <div id="addBirthdayForm" class="hidden subtoggle form-grid">
        <label>Name<input type="text" id="bdayName" placeholder="e.g., Alex"></label>
        <label>Birthday<input type="date" id="bdayDate"></label>
        <label style="grid-column:1/-1;">Notes<textarea id="bdayNotes" rows="2" placeholder="Optional notes"></textarea></label>
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addBirthday()">Submit</button>
        </div>
      </div>
    </div>
  </section>

  <section>
    <div class="toggle section-header" onclick="toggle('developmentSection')">
      Development Activities
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('developmentSection')" title="Pin section open">
        <svg viewBox="0 0 24 24" fill="#2B2C29" stroke="#F7F6F3" stroke-width="1">
          <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
        </svg>
      </span>
    </div>
    <div id="developmentSection" class="hidden">
      <div id="activityList"></div>
      <div class="toggle add-toggle" onclick="toggle('addActivityForm')">Add Development Activity</div>
      <div id="addActivityForm" class="hidden subtoggle form-grid">
        <label>Name<input type="text" id="activityName"></label>
        <label>Skill<select id="activitySkill"></select></label>
        <label style="grid-column:1/-1;">Info
          <textarea id="activityInfo" rows="3" placeholder="Notes, goals, resources, etc." style="width:100%;"></textarea>
        </label>
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addActivity()">Submit</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Relationship Log Section as its own separate section -->
  <section>
    <div class="toggle section-header" onclick="toggle('relationshipSection')">
      Relationship Log
      <span class="pin-star" onclick="event.stopPropagation(); togglePin('relationshipSection')" title="Pin section open">
        <svg viewBox="0 0 20 20" fill="none" stroke="#2B2C29" stroke-width="1.5"><polygon points="10,2 12.5,7.5 18,8 14,12 15,18 10,15 5,18 6,12 2,8 7.5,7.5"/></svg>
      </span>
    </div>
    <div id="relationshipSection" class="hidden">
      <div class="form-grid">
        <label>Date<input type="date" id="relDate"></label>
        <label>Trigger<input type="text" id="relTrigger"></label>
        <label>Content<textarea id="relContent"></textarea></label>
        <label>With Who
          <div style="display:flex; gap:0.5rem;">
            <select id="relWithWho" style="flex:1;"></select>
            <button class="btn-outline" type="button" onclick="addPerson()">+</button>
          </div>
        </label>
        <label>Intensity<input type="number" id="relIntensity" min="0" max="100"></label>
        <label>Duration
          <div style="display:flex; gap:0.5rem;">
            <input type="number" id="relDurationValue" style="flex:1;">
            <select id="relDurationUnit">
              <option value="mins">mins</option>
              <option value="hours">hours</option>
              <option value="days">days</option>
              <option value="weeks">weeks</option>
            </select>
          </div>
        </label>
        <label>Resolution<textarea id="relResolution"></textarea></label>
        <label>Lessons<textarea id="relLessons"></textarea></label>
        <div style="grid-column:1/-1;text-align:center;">
          <button class="submit-btn" onclick="addRelationship()">Submit</button>
        </div>
      </div>
      <div id="relationshipList"></div>
    </div>
  </section>

  <section>
    <div class="toggle section-header" onclick="toggle('settings')">Settings</div>
    <div id="settings" class="hidden">
      <h3>Add Skill</h3>
      <div class="inline-form" style="margin-bottom:0.5rem;">
        <label>Skill Name
          <input id="skillName" type="text" placeholder="e.g., Reading practice" />
        </label>
        <label>Color
          <input id="skillColor" type="color" value="#B5A89A" />
        </label>
        <button class="submit-btn" onclick="addSkill()">Add</button>
      </div>
      <div id="skills"></div>
    </div>
  </section>

  <div id="editSkillModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Skill</h3>
        <span class="close" onclick="closeEditSkillModal()">&times;</span>
      </div>
      <div class="modal-body">
        <label>Skill Name
          <input id="editSkillName" type="text" />
        </label>
        <label>Color
          <input id="editSkillColor" type="color" />
        </label>
        <label>Status
          <select id="editSkillStatus">
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </label>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="closeEditSkillModal()">Cancel</button>
        <button class="submit-btn" onclick="saveSkillChanges()">Save</button>
      </div>
    </div>
  </div>

  <!-- Activity Info Modal -->
  <div id="activityInfoModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Activity Info</h3>
        <span class="close" onclick="closeActivityInfoModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="activityInfoName" style="font-weight:600; margin-bottom:0.5rem;"></div>
        <label style="width:100%; display:block;">
          <span style="display:block; font-weight:500; margin-bottom:0.25rem;">Details</span>
          <textarea id="editActivityInfo" rows="6" style="width:100%;"></textarea>
        </label>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="closeActivityInfoModal()">Close</button>
        <button class="submit-btn" onclick="saveActivityInfo()">Save</button>
      </div>
    </div>
  </div>

  <!-- Relationship Edit Modal -->
  <div id="editRelModal" class="modal hidden">
    <div class="modal-content form-grid">
      <label>Date<input type="date" id="editRelDate"></label>
      <label>Trigger<input type="text" id="editRelTrigger"></label>
      <label>Content<textarea id="editRelContent"></textarea></label>
      <label>With Who<select id="editRelWithWho"></select></label>
      <label>Intensity<input type="number" id="editRelIntensity" min="0" max="100"></label>
      <label>Duration
        <div style="display:flex;gap:0.5rem;">
          <input type="number" id="editRelDurationValue" style="flex:1;">
          <select id="editRelDurationUnit">
            <option value="mins">mins</option>
            <option value="hours">hours</option>
            <option value="days">days</option>
            <option value="weeks">weeks</option>
          </select>
        </div>
      </label>
      <label>Resolution<textarea id="editRelResolution"></textarea></label>
      <label>Lessons<textarea id="editRelLessons"></textarea></label>
      <div style="grid-column:1/-1;text-align:right;">
        <button class="btn" onclick="saveEdit()">Save</button>
        <button class="btn" onclick="closeEditModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    function toggle(id){ const el=document.getElementById(id); if(el) el.classList.toggle('hidden'); }

    // Development Activities Data
    let skills=[]; let activities=[]; let nextSkillId=1; let nextActivityId=1; let editingSkillId=null; let editingActivityInfoId=null;

  // Relationship Data
  let people=[]; let entries=[]; let nextEntryId=1; let editingId=null;

  // Birthdays Data
  let birthdays=[]; let nextBirthdayId=1;

    async function loadFamilyFriends(){
      try {
        const res = await fetch('/api/family-friends-data');
        if(!res.ok) throw new Error('Failed to load family-friends-data');
        const data = await res.json();
        
        // Development Activities
        skills = Array.isArray(data.skills)?data.skills:[];
        activities = Array.isArray(data.activities)?data.activities:[];
        nextSkillId = Number(data.nextSkillId)||1;
        nextActivityId = Number(data.nextActivityId)||1;
        
  // Relationships
        people = Array.isArray(data.people)?data.people:[];
        entries = Array.isArray(data.entries)?data.entries:[];
        nextEntryId = Number(data.nextEntryId)||1;

  // Birthdays
  birthdays = Array.isArray(data.birthdays)?data.birthdays:[];
  nextBirthdayId = Number(data.nextBirthdayId)||1;
      } catch(err){
        console.warn('Using defaults for family-friends data', err);
  skills=[]; activities=[]; nextSkillId=1; nextActivityId=1;
  people=[]; entries=[]; nextEntryId=1;
  birthdays=[]; nextBirthdayId=1;
      }
    }

    async function saveFamilyFriends(){
      const payload = { 
        skills, activities, nextSkillId, nextActivityId,
        people, entries, nextEntryId,
        birthdays, nextBirthdayId
      };
      await fetch('/api/family-friends-data', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
    }

    function formatUK(date){ const d=new Date(date); if(isNaN(d)) return date||''; return d.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'2-digit'}); }
    function countLastMonth(dates){
      const cutoff=new Date();
      cutoff.setMonth(cutoff.getMonth()-1);
      return dates.filter(d=>new Date(d)>=cutoff).length;
    }

    function updateSkillOptions(){
      const sel=document.getElementById('activitySkill');
      if(!sel) return;
      sel.innerHTML='';
      skills.filter(s=>!s.closed).forEach(s=>{
        const opt=document.createElement('option');
        opt.value=s.id;
        opt.textContent=s.name;
        sel.appendChild(opt);
      });
    }

    function hasOpenActivities(skillId){
      if(!Array.isArray(activities) || activities.length===0) return false;
      return activities.some(a => a.skillId===skillId && !a.completed);
    }

    function addSkill(){
      const name = (document.getElementById('skillName').value||'').trim();
      const color = document.getElementById('skillColor').value||'#B5A89A';
      if(!name) return;
      skills.push({ id: nextSkillId++, name, color, closed:false });
      document.getElementById('skillName').value='';
      renderSkills();
      updateSkillOptions();
      saveFamilyFriends();
    }

    function openEditSkillModal(id){
      const s = skills.find(x=>x.id===id); if(!s) return;
      editingSkillId=id;
      document.getElementById('editSkillName').value = s.name||'';
      document.getElementById('editSkillColor').value = s.color||'#B5A89A';
      document.getElementById('editSkillStatus').value = s.closed ? 'closed' : 'open';
      document.getElementById('editSkillModal').classList.remove('hidden');
    }

    function closeEditSkillModal(){
      document.getElementById('editSkillModal').classList.add('hidden');
      editingSkillId=null;
    }

    function saveSkillChanges(){
      if(editingSkillId==null) return;
      const s = skills.find(x=>x.id===editingSkillId); if(!s) return;
      s.name = (document.getElementById('editSkillName').value||'').trim();
      s.color = document.getElementById('editSkillColor').value||'#B5A89A';
      s.closed = (document.getElementById('editSkillStatus').value==='closed');
      closeEditSkillModal();
      renderSkills();
      saveFamilyFriends();
    }

    function toggleClosed(id){ const s=skills.find(x=>x.id===id); if(!s) return; s.closed=!s.closed; renderSkills(); saveFamilyFriends(); }
    function deleteSkill(id){ skills = skills.filter(s=>s.id!==id); renderSkills(); saveFamilyFriends(); }

    function renderSkills(){
      const container = document.getElementById('skills');
      container.innerHTML='';
      const table = document.createElement('table'); table.className='task-table';
      const thead = document.createElement('thead'); const hr=document.createElement('tr');
      ['Skill','Task Status','Color','Action'].forEach(t=>{ const th=document.createElement('th'); th.textContent=t; hr.appendChild(th); });
      thead.appendChild(hr); table.appendChild(thead);
      const tbody = document.createElement('tbody');
      skills.forEach(s=>{
        const tr=document.createElement('tr');
        const tdName=document.createElement('td'); tdName.textContent=s.name||''; tr.appendChild(tdName);
        const tdStatus=document.createElement('td'); tdStatus.textContent = s.closed ? 'Closed' : (hasOpenActivities(s.id) ? 'Allocated' : 'Open'); tr.appendChild(tdStatus);
        const tdColor=document.createElement('td');
        const sw=document.createElement('span'); sw.className='color-swatch'; sw.style.background=s.color||'#B5A89A'; tdColor.appendChild(sw);
        const code=document.createElement('span'); code.textContent=s.color||''; tdColor.appendChild(code); tr.appendChild(tdColor);
        const tdAct=document.createElement('td');
        const bEdit=document.createElement('button'); bEdit.textContent='Edit'; bEdit.onclick=()=>openEditSkillModal(s.id);
        const bClose=document.createElement('button'); bClose.textContent=s.closed?'Reopen':'Close'; bClose.onclick=()=>toggleClosed(s.id);
        const bDel=document.createElement('button'); bDel.textContent='Delete'; bDel.onclick=()=>deleteSkill(s.id);
        [bEdit,bClose,bDel].forEach(b=>{ b.style.marginRight='0.25rem'; });
        tdAct.appendChild(bEdit); tdAct.appendChild(bClose); tdAct.appendChild(bDel);
        tr.appendChild(tdAct);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
      updateSkillOptions();
    }

    function addActivity(){
      const name=(document.getElementById('activityName').value||'').trim();
      const skillId=Number(document.getElementById('activitySkill').value);
      const info=(document.getElementById('activityInfo').value||'').trim();
      if(!name||!skillId) return;
      const act={id:String(nextActivityId++).padStart(8,'0'),name,skillId,info,completedDates:[],status:'open',dueDate:''};
      activities.push(act);
      document.getElementById('activityName').value='';
      document.getElementById('activityInfo').value='';
      renderActivities();
      saveFamilyFriends();
    }

    function renderActivities(){
      const container=document.getElementById('activityList');
      container.innerHTML='';
      const open=activities.filter(a=>a.status==='open');
      if(open.length===0){container.textContent='No development activities';return;}
      const table=document.createElement('table');table.className='task-table';
      const head=document.createElement('tr');
      head.innerHTML='<th>Activity</th><th>Last Done</th><th>How Frequently</th><th style="min-width:200px;">Action</th>';
      table.appendChild(head);
      open.forEach(a=>{
        const tr=document.createElement('tr');
        const skill=skills.find(s=>s.id===a.skillId);
        const color=skill?skill.color:'#000';
        const last=a.completedDates.length?formatUK(a.completedDates[a.completedDates.length-1]):'';
        const freq=countLastMonth(a.completedDates);

        const taskCell=document.createElement('td');
        const nameDiv=document.createElement('div');nameDiv.textContent=a.name;nameDiv.style.fontWeight='500';
        const infoRow=document.createElement('div'); infoRow.style.marginTop='0.2rem';
        const infoBtn=document.createElement('button');
        infoBtn.title='View/Edit Info'; infoBtn.style.background='none'; infoBtn.style.border='none'; infoBtn.style.cursor='pointer'; infoBtn.style.padding='0';
        infoBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#C7BBB4"/><rect x="9" y="8" width="2" height="6" rx="1" fill="#2B2C29"/><rect x="9" y="5" width="2" height="2" rx="1" fill="#2B2C29"/></svg>';
        infoBtn.onclick=()=>openActivityInfoModal(a.id);
        infoRow.appendChild(infoBtn);
        const skillDiv=document.createElement('div');skillDiv.textContent=skill?skill.name:'';skillDiv.style.color=color;skillDiv.style.fontSize='0.8rem';skillDiv.style.marginTop='0.2rem';
        taskCell.appendChild(nameDiv);
        taskCell.appendChild(infoRow);
        taskCell.appendChild(skillDiv);
        tr.appendChild(taskCell);

        const lastTd=document.createElement('td');lastTd.textContent=last;tr.appendChild(lastTd);
        const freqTd=document.createElement('td');freqTd.textContent=freq;tr.appendChild(freqTd);

        const td=document.createElement('td');
        td.style.display='grid';td.style.gridTemplateColumns='repeat(3,1fr)';td.style.gap='0.2rem';td.style.padding='0.5rem';td.style.alignItems='center';td.style.justifyItems='center';td.style.height='auto';td.style.minHeight='60px';td.style.minWidth='200px';

        const addBtn=document.createElement('button');
        addBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
        addBtn.title='Add to Today';addBtn.style.background='none';addBtn.style.border='none';addBtn.style.cursor='pointer';addBtn.style.padding='2px';
        addBtn.onclick=()=>addActivityToToday(a.id,a.name);
        const timerBtn=createTimerButton('family-friends', a.name);timerBtn.style.padding='2px';

        const logBtn=document.createElement('button');
        logBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#81B29A"/><path d="m6 10 2 2 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        logBtn.title='Log Completion';logBtn.style.background='none';logBtn.style.border='none';logBtn.style.cursor='pointer';logBtn.style.padding='2px';
        logBtn.onclick=()=>logActivity(a.id);

        const editBtn=document.createElement('button');
        editBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="14" height="12" rx="2" fill="#B5A89A"/><path d="m6 2v4m8-4v4" stroke="#2B2C29" stroke-width="2" stroke-linecap="round"/><path d="M3 8h14" stroke="#2B2C29" stroke-width="2"/><circle cx="8" cy="12" r="1" fill="#2B2C29"/><circle cx="12" cy="12" r="1" fill="#2B2C29"/></svg>';
        editBtn.title='Edit Due Date';editBtn.style.background='none';editBtn.style.border='none';editBtn.style.cursor='pointer';editBtn.style.padding='2px';
        editBtn.onclick=()=>editActivityDue(a.id);

        const archiveBtn=document.createElement('button');
        archiveBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="14" height="3" rx="2" fill="#B5A89A"/><rect x="5" y="8" width="10" height="8" rx="2" fill="#C7BBB4"/><rect x="8" y="11" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
        archiveBtn.title='Archive';archiveBtn.style.background='none';archiveBtn.style.border='none';archiveBtn.style.cursor='pointer';archiveBtn.style.padding='2px';
        archiveBtn.onclick=()=>confirmArchiveActivity(a.id,a.name);

        const delBtn=document.createElement('button');
        delBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="8" width="8" height="8" rx="2" fill="#E07A5F"/><rect x="9" y="11" width="2" height="3" rx="1" fill="#fff"/><rect x="8" y="4" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
        delBtn.title='Delete';delBtn.style.background='none';delBtn.style.border='none';delBtn.style.cursor='pointer';delBtn.style.padding='2px';
        delBtn.onclick=()=>confirmDeleteActivity(a.id,a.name);

        td.appendChild(addBtn);
        td.appendChild(timerBtn);
        td.appendChild(logBtn);
        td.appendChild(editBtn);
        td.appendChild(archiveBtn);
        td.appendChild(delBtn);
        tr.appendChild(td);
        table.appendChild(tr);
      });
      container.appendChild(table);
    }

    function openActivityInfoModal(id){
      const act=activities.find(a=>a.id===id); if(!act) return;
      editingActivityInfoId=id;
      const nameDiv=document.getElementById('activityInfoName');
      nameDiv.textContent = act.name || '';
      const oldBtn=document.getElementById('activityInfoTimerBtn');
      if(oldBtn) oldBtn.remove();
      const timerBtn=createTimerButton('family-friends', act.name);
      timerBtn.id='activityInfoTimerBtn';
      timerBtn.style.marginLeft='0.25rem';
      nameDiv.appendChild(timerBtn);
      document.getElementById('editActivityInfo').value = act.info || '';
      document.getElementById('activityInfoModal').classList.remove('hidden');
    }

    function closeActivityInfoModal(){
      document.getElementById('activityInfoModal').classList.add('hidden');
      editingActivityInfoId=null;
    }

    function saveActivityInfo(){
      if(!editingActivityInfoId) return;
      const act=activities.find(a=>a.id===editingActivityInfoId); if(!act) return;
      act.info = document.getElementById('editActivityInfo').value;
      saveFamilyFriends();
      closeActivityInfoModal();
      renderActivities();
    }

    function logActivity(id){
      const act=activities.find(a=>a.id===id);
      if(!act) return;
      act.completedDates.push(new Date().toISOString().slice(0,10));
      saveFamilyFriends();
      renderActivities();
    }

    function editActivityDue(id){
      const act=activities.find(a=>a.id===id);
      if(!act) return;
      const newDue=prompt('Enter new due date (YYYY-MM-DD):', act.dueDate||'');
      if(newDue!==null){act.dueDate=newDue; saveFamilyFriends(); renderActivities();}
    }

    function confirmArchiveActivity(id,name){ if(!confirm(`Are you sure you want to archive the activity "${name}"?`)) return; archiveActivity(id); }
    function archiveActivity(id){ const act=activities.find(a=>a.id===id); if(!act) return; act.status='closed'; act.closedDate=new Date().toISOString().slice(0,10); saveFamilyFriends(); renderActivities(); }
    function confirmDeleteActivity(id,name){ if(!confirm(`Are you sure you want to delete the activity "${name}"? This action cannot be undone.`)) return; deleteActivity(id); }
    function deleteActivity(id){ activities=activities.filter(a=>a.id!==id); saveFamilyFriends(); renderActivities(); }

    async function addActivityToToday(id,name){
      try{
        const res = await fetch('/api/add-to-today',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({taskType:'family-friends',taskId:id,taskName:name})});
        const result = await res.json();
        if(result.status === 'ok'){
          console.log(`Added to Today: ${name}`);
        }else if(result.status === 'already_exists'){
          alert('Task is already on today list');
        }else{
          alert('Failed to add to Today');
        }
      }catch(e){
        console.error('Error adding to Today', e);
        alert('Error adding to Today');
      }
    }

    // Relationship functions
    function renderPeople(){
      const sel=document.getElementById('relWithWho');
      sel.innerHTML='';
      people.forEach(p=>{
        const opt=document.createElement('option');
        opt.value=p;
        opt.textContent=p;
        sel.appendChild(opt);
      });
    }

    function addPerson(){
      const name=prompt('Name?');
      if(!name || people.includes(name)) return;
      people.push(name);
      renderPeople();
      saveFamilyFriends();
    }

    function addRelationship(){
      const date=document.getElementById('relDate').value;
      const trigger=document.getElementById('relTrigger').value.trim();
      const content=document.getElementById('relContent').value.trim();
      const withWho=document.getElementById('relWithWho').value;
      const intensity=parseInt(document.getElementById('relIntensity').value)||0;
      const durationVal=document.getElementById('relDurationValue').value;
      const durationUnit=document.getElementById('relDurationUnit').value;
      const duration=durationVal?`${durationVal} ${durationUnit}`:'';
      const resolution=document.getElementById('relResolution').value.trim();
      const lessons=document.getElementById('relLessons').value.trim();
      entries.push({id:nextEntryId++,date,trigger,content,withWho,intensity,duration,resolution,lessons,archived:false});
      document.querySelectorAll('#relationshipSection input, #relationshipSection textarea').forEach(el=>{if(el.type!=='button') el.value='';});
      renderEntries();
      saveFamilyFriends();
    }

    function renderEntries(){
      const list=document.getElementById('relationshipList');
      const active=entries.filter(e=>!e.archived);
      if(!active.length){ list.innerHTML='<p style="opacity:.7">No entries yet.</p>'; return; }
      const table=document.createElement('table');
      table.className='task-table';
      const head=document.createElement('tr');
      head.innerHTML='<th>Date</th><th>Duration</th><th>Intensity</th><th>Resolution</th><th>Actions</th>';
      table.appendChild(head);
      active.forEach(e=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${e.date||''}</td><td>${e.duration||''}</td><td>${e.intensity}</td><td>${e.resolution||''}</td>`;
        const actTd=document.createElement('td');
        actTd.style.textAlign='center';
        const editBtn=document.createElement('button');
        editBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5858 3.58579C14.3668 2.80474 15.6332 2.80474 16.4142 3.58579C17.1953 4.36683 17.1953 5.63316 16.4142 6.41421L15.6213 7.20711L12.7929 4.37868L13.5858 3.58579Z" fill="#B5A89A"/><path d="M11.3787 5.79289L3 14.1716V17H5.82842L14.2071 8.62132L11.3787 5.79289Z" fill="#C7BBB4"/></svg>';
        editBtn.title='Edit';
        editBtn.style.background='none'; editBtn.style.border='none'; editBtn.style.cursor='pointer'; editBtn.style.padding='2px';
        editBtn.onclick=()=>openEdit(e.id);
        const delBtn=document.createElement('button');
        delBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="8" width="8" height="8" rx="2" fill="#E07A5F"/><rect x="9" y="11" width="2" height="3" rx="1" fill="#fff"/><rect x="8" y="4" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
        delBtn.title='Delete';
        delBtn.style.background='none'; delBtn.style.border='none'; delBtn.style.cursor='pointer'; delBtn.style.padding='2px';
        delBtn.onclick=()=>deleteEntry(e.id);
        const archBtn=document.createElement('button');
        archBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="14" height="3" rx="2" fill="#B5A89A"/><rect x="5" y="8" width="10" height="8" rx="2" fill="#C7BBB4"/><rect x="8" y="11" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
        archBtn.title='Archive';
        archBtn.style.background='none'; archBtn.style.border='none'; archBtn.style.cursor='pointer'; archBtn.style.padding='2px';
        archBtn.onclick=()=>archiveEntry(e.id);
        actTd.appendChild(editBtn); actTd.appendChild(delBtn); actTd.appendChild(archBtn);
        tr.appendChild(actTd);
        table.appendChild(tr);
      });
      list.innerHTML='';
      list.appendChild(table);
    }

    function openEdit(id){
      const e=entries.find(en=>en.id===id); if(!e) return;
      editingId=id;
      document.getElementById('editRelDate').value=e.date||'';
      document.getElementById('editRelTrigger').value=e.trigger||'';
      document.getElementById('editRelContent').value=e.content||'';
      const sel=document.getElementById('editRelWithWho');
      sel.innerHTML='';
      people.forEach(p=>{ const opt=document.createElement('option'); opt.value=p; opt.textContent=p; if(p===e.withWho) opt.selected=true; sel.appendChild(opt); });
      document.getElementById('editRelIntensity').value=e.intensity||0;
      const parts=e.duration?e.duration.split(' '):['','mins'];
      document.getElementById('editRelDurationValue').value=parts[0]||'';
      document.getElementById('editRelDurationUnit').value=parts[1]||'mins';
      document.getElementById('editRelResolution').value=e.resolution||'';
      document.getElementById('editRelLessons').value=e.lessons||'';
      document.getElementById('editRelModal').classList.remove('hidden');
    }

    function closeEditModal(){
      document.getElementById('editRelModal').classList.add('hidden');
      editingId=null;
    }

    function saveEdit(){
      const e=entries.find(en=>en.id===editingId); if(!e) return;
      e.date=document.getElementById('editRelDate').value;
      e.trigger=document.getElementById('editRelTrigger').value.trim();
      e.content=document.getElementById('editRelContent').value.trim();
      e.withWho=document.getElementById('editRelWithWho').value;
      e.intensity=parseInt(document.getElementById('editRelIntensity').value)||0;
      const dv=document.getElementById('editRelDurationValue').value;
      const du=document.getElementById('editRelDurationUnit').value;
      e.duration=dv?`${dv} ${du}`:'';
      e.resolution=document.getElementById('editRelResolution').value.trim();
      e.lessons=document.getElementById('editRelLessons').value.trim();
      closeEditModal();
      renderEntries();
      saveFamilyFriends();
    }

    function deleteEntry(id){
      if(!confirm('Delete this entry?')) return;
      entries=entries.filter(e=>e.id!==id);
      renderEntries();
      saveFamilyFriends();
    }

    function archiveEntry(id){
      const e=entries.find(en=>en.id===id); if(!e) return;
      e.archived=true;
      renderEntries();
      saveFamilyFriends();
    }

    function togglePin(sectionId){
      const star=document.querySelector(`[onclick*="togglePin('${sectionId}')"]`);
      const pinned=!star.classList.contains('pinned');
      star.classList.toggle('pinned');
      let pins=JSON.parse(localStorage.getItem('familyFriendsPins')||'[]');
      if(pinned){
        pins.push(sectionId);
        const sec=document.getElementById(sectionId); if(sec) sec.classList.remove('hidden');
      } else {
        pins=pins.filter(id=>id!==sectionId);
      }
      localStorage.setItem('familyFriendsPins',JSON.stringify(pins));
    }

    function restorePins(){
      const pins=JSON.parse(localStorage.getItem('familyFriendsPins')||'[]');
      pins.forEach(id=>{
        const star=document.querySelector(`[onclick*="togglePin('${id}')"]`);
        if(star) star.classList.add('pinned');
        const sec=document.getElementById(id); if(sec) sec.classList.remove('hidden');
      });
    }

    // Birthdays functions
    function addBirthday(){
      const name=(document.getElementById('bdayName').value||'').trim();
      const date=document.getElementById('bdayDate').value||'';
      const notes=(document.getElementById('bdayNotes').value||'').trim();
      if(!name||!date) return;
      birthdays.push({ id:String(nextBirthdayId++).padStart(8,'0'), name, date, notes });
      document.getElementById('bdayName').value='';
      document.getElementById('bdayDate').value='';
      document.getElementById('bdayNotes').value='';
      renderBirthdays();
      saveFamilyFriends();
    }

    function renderBirthdays(){
      const container=document.getElementById('birthdaysList');
      container.innerHTML='';
      if(!birthdays.length){ container.textContent='No birthdays added yet'; return; }
      const table=document.createElement('table'); table.className='task-table';
      const head=document.createElement('tr'); head.innerHTML='<th>Name</th><th>Birthday</th><th>Notes</th><th>Action</th>';
      table.appendChild(head);
      birthdays
        .slice()
        .sort((a,b)=> a.name.localeCompare(b.name))
        .forEach(b=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${b.name}</td><td>${b.date||''}</td>`;
          const notesTd=document.createElement('td');
          const notesInput=document.createElement('textarea');
          notesInput.rows=2; notesInput.style.width='100%';
          notesInput.value=b.notes||'';
          notesInput.onchange=()=>{ b.notes=notesInput.value.trim(); saveFamilyFriends(); };
          notesTd.appendChild(notesInput);
          tr.appendChild(notesTd);
          const actionTd=document.createElement('td');
          actionTd.style.display='grid'; actionTd.style.gridTemplateColumns='repeat(2,1fr)'; actionTd.style.gap='0.2rem'; actionTd.style.justifyItems='center'; actionTd.style.alignItems='center';
          // Edit (use same calendar icon style)
          const editBtn=document.createElement('button');
          editBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="14" height="12" rx="2" fill="#B5A89A"/><path d="m6 2v4m8-4v4" stroke="#2B2C29" stroke-width="2" stroke-linecap="round"/><path d="M3 8h14" stroke="#2B2C29" stroke-width="2"/><circle cx="8" cy="12" r="1" fill="#2B2C29"/><circle cx="12" cy="12" r="1" fill="#2B2C29"/></svg>';
          editBtn.title='Edit name/date'; editBtn.style.background='none'; editBtn.style.border='none'; editBtn.style.cursor='pointer'; editBtn.style.padding='2px';
          editBtn.onclick=()=>{
            const n=prompt('Name:', b.name||''); if(n===null) return;
            const d=prompt('Birthday (YYYY-MM-DD):', b.date||''); if(d===null) return;
            b.name=n.trim(); b.date=d; saveFamilyFriends(); renderBirthdays();
          };
          // Delete (trash icon)
          const delBtn=document.createElement('button');
          delBtn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="8" width="8" height="8" rx="2" fill="#E07A5F"/><rect x="9" y="11" width="2" height="3" rx="1" fill="#fff"/><rect x="8" y="4" width="4" height="2" rx="1" fill="#2B2C29"/></svg>';
          delBtn.title='Delete'; delBtn.style.background='none'; delBtn.style.border='none'; delBtn.style.cursor='pointer'; delBtn.style.padding='2px';
          delBtn.onclick=()=>{ if(!confirm('Delete this birthday?')) return; birthdays = birthdays.filter(x=>x.id!==b.id); saveFamilyFriends(); renderBirthdays(); };
          actionTd.appendChild(editBtn); actionTd.appendChild(delBtn);
          tr.appendChild(actionTd);
          table.appendChild(tr);
        });
      container.appendChild(table);
    }

    async function init(){ 
  await loadFamilyFriends(); 
      renderSkills(); 
      renderActivities(); 
      renderPeople(); 
      renderEntries(); 
  renderBirthdays();
      restorePins(); 
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

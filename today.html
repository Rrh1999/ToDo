<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Today</title>
<link rel="stylesheet" href="styles.css">
<style>
/* page specific layout only */
body { margin: 0; padding: 0; }
/* header styling removed to defer to global stylesheet */
#todaySection { padding: 1rem; border-bottom: 2px solid #e2e5e9; margin-bottom: 1rem; }
#container { display: flex; }
#side { width: 50%; padding: 1rem; border-right: 1px solid #ccc; }
#main { flex: 1; padding: 1rem; }
.task-list { list-style: none; padding: 0; }
.task-list li { margin: 0.25rem 0; padding: 0.25rem; border-bottom: 1px solid #ddd; display:flex; justify-content: space-between; align-items:center; flex-wrap:wrap; }
#todayListContainer{width:100%;}
.overdue { color: red; }
.due { color: orange; }
.due-soon { font-weight: bold; }
.today-item { cursor: move; }

/* Modal styles */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
.modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: none; width: 90%; max-width: 1200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.close:hover, .close:focus { color: black; text-decoration: none; }

/* Task grid for modal */
.task-grid { display: grid; grid-template-columns: 2fr repeat(7, 1fr); gap: 0.5rem; border: 1px solid #e2e5e9; background: #fff; padding: 0.5rem; border-radius: 4px; }
.task-grid div { padding: 0.5rem; border: 1px solid #e2e5e9; text-align: center; }
.grid-header { background: #C7BBB4; font-weight: bold; color: #2B2C29; }
.task-info { display: flex; justify-content: space-between; align-items: center; text-align: left; }
.task-details { flex: 1; }
.task-name { font-size: 0.9rem; font-weight: 500; color: #2B2C29; }
.task-meta { font-size: 0.8rem; color: #7D7D7D; }
.task-actions { display: flex; gap: 0.25rem; }
.circle { display: inline-block; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; }
.purple { background: #E8B4A3; }
.grey { background: #ccc; }
.green { background: #81B29A; color: #fff; }

.today-col { background: #C8B8DB !important; }

@media (max-width: 600px) {
  html { font-size: 14px; }
  .modal-content { width: 95%; margin: 2% auto; }
  .task-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<header>
  <h1>Today</h1>
</header>
<div id="nav-placeholder"></div>
<script src="nav-loader.js"></script>
<script>
// Timer fallback to avoid crashes if time-tracker.js loads later
(function(){
  try{
    if(typeof window.createTimerButton!=="function"){
      window.createTimerButton=function(source,name){
        const btn=document.createElement('button');
        btn.innerHTML='<svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" stroke="#2B2C29" stroke-width="2" fill="#C7BBB4"/><path d="M10 5v5l3 3" stroke="#2B2C29" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        btn.title='Start timer';
        btn.style.background='none';
        btn.style.border='none';
        btn.style.cursor='pointer';
        btn.addEventListener('click',()=>{
          if(typeof window.startTask==='function') window.startTask(source,name);
          else console.warn('[time-tracker] startTask not ready yet');
        });
        return btn;
      };
    }
    if(typeof window.startTask!=="function"){ window.startTask=function(){ console.warn('[time-tracker] startTask not ready yet'); }; }
    if(typeof window.stopTask!=="function"){ window.stopTask=function(){ console.warn('[time-tracker] stopTask not ready yet'); }; }
  }catch(e){}
})();
</script>

<!-- To Do Tasks Section -->
<div id="todoTasksSection" style="padding: 1rem; margin-top: 1rem;">
  <h2>To Do Tasks</h2>
  <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
    <button onclick="openWeeklyTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Weekly Tasks</button>
  <button onclick="openOneOffTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">One-Off Tasks</button>
  <button onclick="openRecurringTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Recurring Tasks</button>
  <button onclick="openWorkTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Work Tasks</button>
  <button onclick="openDiyTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">DIY Tasks</button>
  <button onclick="openBigTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Big Tasks</button>
  <button onclick="openStretchTasksModal()" style="padding: 0.75rem 1.5rem; background: #B5A89A; color: #2B2C29; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Stretch Tasks</button>
  </div>

  <!-- Today Data Management Section -->
  <div style="margin-top: 2rem; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border: 1px solid #e2e5e9;">
    <h3 style="margin: 0 0 1rem 0; color: #2B2C29; font-size: 1.2rem;">Today</h3>
    
    <!-- Add Quick Item -->
    <div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; align-items: center;">
      <input type="text" id="quickTodayItem" placeholder="Add quick item..." style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
      <button onclick="addQuickTodayItem()" style="padding: 0.5rem 1rem; background: #B8A4D9; color: white; border: none; border-radius: 4px; cursor: pointer;">Add</button>
    </div>
    
    <!-- Today Data List -->
    <div id="todayDataList" style="min-height: 200px;">
      <!-- Items will be populated here -->
    </div>
  </div>
</div>

<!-- Weekly Tasks Modal -->
<div id="weeklyTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: none; width: 90%; max-width: 1200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">Weekly Tasks</h3>
      <span class="close" onclick="closeWeeklyTasksModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    </div>
    <div class="modal-body">
      <div class="week-controls" style="text-align: center; margin-bottom: 1rem;">
        <button onclick="changeModalWeek(-1)" style="padding: 0.5rem 1rem; margin: 0 0.5rem; background: #C7BBB4; border: none; border-radius: 4px; cursor: pointer;">&#8592;</button>
        <span id="modalWeekLabel" style="font-weight:bold;color:#2B2C29; margin: 0 1rem;"></span>
        <button onclick="changeModalWeek(1)" style="padding: 0.5rem 1rem; margin: 0 0.5rem; background: #C7BBB4; border: none; border-radius: 4px; cursor: pointer;">&#8594;</button>
      </div>
      <div id="modalWeeklyGrid" class="task-grid" style="display: grid; grid-template-columns: 2fr repeat(7, 1fr); gap: 0.5rem; border: 1px solid #e2e5e9; background: #fff;">
        <!-- Grid content will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- One-Off Tasks Modal -->
<div id="oneOffTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">One-Off Tasks</h3>
      <span class="close" onclick="closeOneOffTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalOneOffTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- Recurring Tasks Modal -->
<div id="recurringTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Recurring Tasks</h3>
      <span class="close" onclick="closeRecurringTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalRecurringTable" style="overflow:auto;"></div>
    </div>
  </div>
</div>

<!-- Work Tasks Modal -->
<div id="workTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Work Tasks</h3>
      <span class="close" onclick="closeWorkTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalWorkTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- DIY Tasks Modal -->
<div id="diyTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">DIY Tasks</h3>
      <span class="close" onclick="closeDiyTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalDiyTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- Big Tasks Modal -->
<div id="bigTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Big Tasks</h3>
      <span class="close" onclick="closeBigTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalBigTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<!-- Stretch Tasks Modal -->
<div id="stretchTasksModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;">Stretch Tasks</h3>
      <span class="close" onclick="closeStretchTasksModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div id="modalStretchTable" style="overflow:auto;"></div>
    </div>
  </div>
  
</div>

<script>
let projects=[], weeklyTasks=[], oneOffTasks=[], recurringTasks=[], stretchTasks=[], bigTasks=[], deletedTasks=[], shoppingList=[], longTermList=[], generalList=[], parentingSkills=[], parentingActivities=[], parentingNextSkillId=1, parentingNextActivityId=1;
let todayData = { linked: [], adHoc: [], nextLinkedId: 1, nextAdHocId: 1 };
let todayList=[], todayTasks=[], todayQuickHistory=[];
// Removed Overdue/Due Soon lists
let nextId=1;
let workDataStore={}, workTasks=[], workCalendar=[];
let diyDataStore={}, diyTasks=[], diyBigTasks=[], diyCalendar=[];
function getWorkTaskInfo(id,list=workTasks,depth=0,parent=null){
  for(const t of list){
    if(t.id===id) return {task:t,parent,depth};
    if(t.subtasks){
      const r=getWorkTaskInfo(id,t.subtasks,depth+1,t);
      if(r) return r;
    }
  }
  return null;
}
function forEachWorkTask(cb,list=workTasks,depth=0,parent=null){
  list.forEach(t=>{
    cb(t,depth,parent);
    if(t.subtasks) forEachWorkTask(cb,t.subtasks,depth+1,t);
  });
}
function getDiyTaskInfo(id,list=diyTasks,depth=0,parent=null){
  for(const t of list){
    if(t.id===id) return {task:t,parent,depth};
    if(t.subtasks){
      const r=getDiyTaskInfo(id,t.subtasks,depth+1,t);
      if(r) return r;
    }
  }
  return null;
}
function forEachDiyTask(cb,list=diyTasks,depth=0,parent=null){
  list.forEach(t=>{
    cb(t,depth,parent);
    if(t.subtasks) forEachDiyTask(cb,t.subtasks,depth+1,t);
  });
}
function taskScheduledToday(type,id){
  const today=formatISO(new Date());
  let events=[];
  if(type==='work') events=workCalendar;
  else if(type==='diy') events=diyCalendar;
  else return false;
  return events.some(ev=>ev.taskId===id && ev.start.slice(0,10)===today);
}
function formatISO(date){const d=new Date(date);const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function formatUK(date){const d=new Date(date);if(isNaN(d)) return date||'';return d.toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'2-digit'});}
function startOfWeek(date){const d=new Date(date);const day=d.getDay();const diff=(day===0?-6:1-day);d.setDate(d.getDate()+diff);d.setHours(0,0,0,0);return d;}
function prevDueDate(task,date){const days=task.days.map(d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].indexOf(d));const d=new Date(date);for(let i=0;i<7;i++){if(days.includes(d.getDay())) return new Date(d);d.setDate(d.getDate()-1);}return null;}
function nextDueDate(task,date){const days=task.days.map(d=>['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].indexOf(d));const d=new Date(date);for(let i=0;i<7;i++){if(days.includes(d.getDay())) return new Date(d);d.setDate(d.getDate()+1);}return null;}
function nearestDueDate(task,date){const prev=prevDueDate(task,date);const next=nextDueDate(task,date);if(!prev) return formatISO(next);if(!next) return formatISO(prev);const mid=new Date(prev.getTime()+(next-prev)/2);return date<mid?formatISO(prev):formatISO(next);}
function lastDueDate(task){return prevDueDate(task,new Date());}
function updateMissed(task){const last=new Date(task.dateLastChecked);const today=new Date();let d=new Date(last);while(d<=today){const dayName=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];const iso=formatISO(d);if(d>last&&task.days.includes(dayName)){if(!task.completedDates.includes(iso)&&!task.missedDates.includes(iso)){task.missedDates.push(iso);}}d.setDate(d.getDate()+1);}task.dateLastChecked=formatISO(today);saveData();}
async function loadData(){
  try{
    // Load today data first (new primary source)
    const resToday = await fetch('/api/today-data');
    if(resToday.ok) {
      todayData = await resToday.json();
    }
    
    // Load legacy index data for compatibility and other page types
    const res=await fetch('/api/index-data');
    if(res.ok){
      const obj=await res.json();
      projects=obj.projects||[];weeklyTasks=obj.weeklyTasks||[];oneOffTasks=obj.oneOffTasks||[];recurringTasks=obj.recurringTasks||[];
      stretchTasks=obj.stretchTasks||[];bigTasks=obj.bigTasks||[];deletedTasks=obj.deletedTasks||[];shoppingList=obj.shoppingList||[];longTermList=obj.longTermList||[];
      generalList=obj.generalList||[];todayList=obj.todayList||[];todayQuickHistory=obj.todayQuickHistory||[];nextId=obj.nextId||1;
    }
    const resW=await fetch('/api/work-data');
    if(resW.ok){
      workDataStore=await resW.json();
      workTasks=workDataStore.workTasks||[];
      workCalendar=workDataStore.calendarEvents||[];
    }
    const resD=await fetch('/api/diy-data');
    if(resD.ok){
      diyDataStore=await resD.json();
      diyTasks=diyDataStore.diyTasks||[];
      diyBigTasks=diyDataStore.diyBigTasks||[];
      diyCalendar=diyDataStore.calendarEvents||[];
    }
    const resP=await fetch('/api/parenting-data');
    if(resP.ok){
      const pd=await resP.json();
      parentingSkills=pd.skills||[];
      parentingActivities=pd.activities||[];
      parentingNextSkillId=pd.nextSkillId||1;
      parentingNextActivityId=pd.nextActivityId||1;
    }
  }catch(e){console.error('Failed to load data',e);}
}
async function saveData(){const data={projects,weeklyTasks,oneOffTasks,recurringTasks,stretchTasks,bigTasks,deletedTasks,shoppingList,longTermList,generalList,todayList,nextId,todayQuickHistory};try{await fetch('/api/index-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});}catch(e){console.error('Failed to save data',e);}}
async function saveWorkData(){
  workDataStore.workTasks = workTasks;
  try{
    await fetch('/api/work-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(workDataStore)});
  }catch(e){console.error('Failed to save work data',e);}
}
async function saveDiyData(){
  diyDataStore.diyTasks = diyTasks;
  diyDataStore.diyBigTasks = diyBigTasks;
  try{
    await fetch('/api/diy-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(diyDataStore)});
  }catch(e){console.error('Failed to save diy data',e);}
}
async function saveParentingData(){
  const data={skills:parentingSkills,activities:parentingActivities,nextSkillId:parentingNextSkillId,nextActivityId:parentingNextActivityId};
  try{await fetch('/api/parenting-data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});}catch(e){console.error('Failed to save parenting data',e);}
}
// Removed categorize/overdue logic
function rebuildToday(){
  todayTasks=[];
  
  // Process linked tasks from todayData (new primary source)
  todayData.linked.forEach(linked => {
    const page = linked.source.page;
    const sourceId = linked.source.id;
    let task = null, depth = 0;
    
    if(page === 'work') {
      const info = getWorkTaskInfo(sourceId);
      if(info) { task = info.task; depth = info.depth; }
    } else if(page === 'diy') {
      const info = getDiyTaskInfo(sourceId);
      if(info) { task = info.task; depth = info.depth; }
    } else if(page === 'index') {
      // Handle index page tasks (stretch, big, etc.)
      if(linked.source.type === 'stretch') task = stretchTasks.find(t => t.id === sourceId);
      else if(linked.source.type === 'big') task = bigTasks.find(t => t.id === sourceId);
      else if(linked.source.type === 'oneoff') task = oneOffTasks.find(t => t.id === sourceId);
      else if(linked.source.type === 'recurring') task = recurringTasks.find(t => t.id === sourceId);
      else if(linked.source.type === 'weekly') task = weeklyTasks.find(t => t.id === sourceId);
    } else if(page === 'parenting') {
      task = parentingActivities.find(a => a.id === sourceId);
    }
    
    if(task) {
      todayTasks.push({
        category: page,
        type: page,
        subtype: linked.source.type || 'task',
        item: task,
        depth: depth || 0,
        todayId: linked.id,
        completed: linked.completedAt ? true : false
      });
    }
  });
  
  // Process ad-hoc tasks from todayData
  todayData.adHoc.forEach(adhoc => {
    todayTasks.push({
      category: 'adhoc',
      type: 'adhoc',
      item: { id: adhoc.id, name: adhoc.text },
      todayId: adhoc.id,
      completed: adhoc.completedAt ? true : false
    });
  });
}
function renderSide(){
  // Side panel removed - function kept as stub to prevent errors
}
function renderWorkTasks(){
  const ul=document.getElementById('workTaskList');
  ul.innerHTML='';
  forEachWorkTask((t,depth)=>{
    if(t.status!=='open') return;
    const li=document.createElement('li');
    li.style.paddingLeft=(depth)+'rem';
    li.textContent=`[Work] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addWorkToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderDiyTasks(){
  const ul=document.getElementById('diyTaskList');
  ul.innerHTML='';
  forEachDiyTask((t,depth)=>{
    if(t.status!=='open') return;
    const li=document.createElement('li');
    li.style.paddingLeft=(depth)+'rem';
    li.textContent=`[DIY] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addDiyToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderStretchTasks(){
  const ul=document.getElementById('stretchTaskList');
  ul.innerHTML='';
  stretchTasks.filter(t=>t.status==='open').forEach(t=>{
    const li=document.createElement('li');
    li.textContent=`[Todo - stretch] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addStretchToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderBigTasks(){
  const ul=document.getElementById('bigTaskList');
  ul.innerHTML='';
  bigTasks.filter(t=>t.status==='open').forEach(t=>{
    const li=document.createElement('li');
    li.textContent=`[Todo - big] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addBigToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}
function renderDiyBigTasks(){
  const ul=document.getElementById('diyBigTaskList');
  ul.innerHTML='';
  diyBigTasks.filter(t=>t.status==='open').forEach(t=>{
    const li=document.createElement('li');
    li.textContent=`[DIY - big] ${t.name} (${t.project})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addDiyBigToToday(t.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}

function renderDevTasks(){
  const ul=document.getElementById('devTaskList');
  ul.innerHTML='';
  parentingActivities.filter(a=>a.status==='open').forEach(a=>{
    const skill=parentingSkills.find(s=>s.id===a.skillId);
    const li=document.createElement('li');
    li.textContent=`[Parenting - dev] ${a.name} (${skill?skill.name:''})`;
    const b=document.createElement('button');
    b.textContent='Add';
    b.onclick=()=>addDevToToday(a.id);
    li.appendChild(b);
    ul.appendChild(li);
  });
}

function addDevToToday(id){
  const task=parentingActivities.find(a=>a.id===id);
  if(!task) return;
  
  // Use new API to add linked item
  fetch('/api/add-to-today', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ 
      type: 'dev',
      id: id,
      text: task.name
    })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderToday();
        updateToggles();
      });
    }
  }).catch(e => console.error('Failed to add dev task to today:', e));
}
function updateToggles(){
  // Toggle elements removed - function kept as stub to prevent errors
}
function renderToday(){
  // Legacy function - now using renderTodayDataList instead
  // Keeping this stub to prevent errors if called from other places
  console.log('renderToday called - using renderTodayDataList instead');
}
// Removed selectTask for overdue/due lists
function addWorkToToday(id){
  const info=getWorkTaskInfo(id);
  if(!info) return;
  
  // Use new API to add linked task
  fetch('/api/add-to-today', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      taskType: 'work',
      taskId: id,
      taskName: info.task.name
    })
  }).then(res => res.json()).then(result => {
    if(result.status === 'ok') {
      loadData().then(() => {
        rebuildToday();
        renderTodayDataList();
        updateToggles();
      });
    } else if(result.status === 'already_exists') {
      alert('Task is already on today list');
    }
  }).catch(e => console.error('Failed to add to today:', e));
}
function addDiyToToday(id){
  const info=getDiyTaskInfo(id);
  if(!info) return;
  
  // Use new API to add linked item
  fetch('/api/add-to-today', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ 
      taskType: 'diy',
      taskId: id,
      taskName: info.task.name
    })
  }).then(res => res.json()).then(result => {
    if(result.status === 'ok') {
      loadData().then(() => {
        rebuildToday();
        renderTodayDataList();
        updateToggles();
      });
    } else if(result.status === 'already_exists') {
      alert('Task is already on today list');
    }
  }).catch(e => console.error('Failed to add DIY task to today:', e));
}
function addStretchToToday(id){
  const task=stretchTasks.find(t=>t.id===id);
  if(!task) return;
  
  // Use new API to add linked item
  fetch('/api/add-to-today', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ 
      type: 'stretch',
      id: id,
      text: task.name
    })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderTodayDataList();
        updateToggles();
      });
    }
  }).catch(e => console.error('Failed to add stretch task to today:', e));
}
function addBigToToday(id){
  const task=bigTasks.find(t=>t.id===id);
  if(!task) return;
  
  // Use new API to add linked item
  fetch('/api/add-to-today', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ 
      type: 'big',
      id: id,
      text: task.name
    })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderTodayDataList();
        updateToggles();
      });
    }
  }).catch(e => console.error('Failed to add big task to today:', e));
}
function addDiyBigToToday(id){
  const task=diyBigTasks.find(t=>t.id===id);
  if(!task) return;
  
  // Use new API to add linked item
  fetch('/api/add-to-today', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ 
      type: 'diybig',
      id: id,
      text: task.name
    })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderToday();
        updateToggles();
      });
    }
  }).catch(e => console.error('Failed to add DIY big task to today:', e));
}

function moveTodayUp(idx){
  if(idx<=0) return;
  
  // Get current order from todayData
  const currentItems = [...todayData.linked, ...todayData.adHoc];
  if (idx >= currentItems.length) return;
  
  // Create new order array by swapping items
  const newOrder = currentItems.map(item => item.id);
  [newOrder[idx-1], newOrder[idx]] = [newOrder[idx], newOrder[idx-1]];
  
  // Send to server
  fetch('/api/today/reorder', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ newOrder })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderToday();
      });
    }
  }).catch(e => console.error('Failed to reorder:', e));
}

function moveTodayDown(idx){
  // Get current order from todayData
  const currentItems = [...todayData.linked, ...todayData.adHoc];
  if(idx>=currentItems.length-1) return;
  
  // Create new order array by swapping items
  const newOrder = currentItems.map(item => item.id);
  [newOrder[idx], newOrder[idx+1]] = [newOrder[idx+1], newOrder[idx]];
  
  // Send to server
  fetch('/api/today/reorder', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ newOrder })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderToday();
      });
    }
  }).catch(e => console.error('Failed to reorder:', e));
}
function addQuickItem(){
  const input=document.getElementById('quickInput');
  const name=input.value.trim();
  if(!name) return;
  
  // Use new API to add ad-hoc item
  fetch('/api/today/adhoc', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ text: name })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      input.value = '';
      loadData().then(() => {
        rebuildToday();
        renderToday();
      });
    }
  }).catch(e => console.error('Failed to add adhoc item:', e));
}
function removeToday(idx){
  const currentItems = [...todayData.linked, ...todayData.adHoc];
  if(idx < 0 || idx >= currentItems.length) return;
  
  const itemToRemove = currentItems[idx];
  
  // Use DELETE API to remove item
  fetch(`/api/today/${itemToRemove.id}`, {
    method: 'DELETE'
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderToday();
        updateToggles();
      });
    }
  }).catch(e => console.error('Failed to remove item:', e));
}
function clearToday(){
  todayTasks.forEach(t=>{ if(t.type==='quick') todayQuickHistory.push({name:t.item.name,added:t.item.added,done:false}); });
  todayTasks=[];
  todayList=[];
  saveData();
  renderSide();
  renderToday();
  updateToggles();
}
function computeNextDue(task,actionDate){const base=(task.from==='today')?new Date(actionDate):new Date(task.dueDate);let d=new Date(base);if(task.frequency==='daily')d.setDate(d.getDate()+task.interval);if(task.frequency==='weekly')d.setDate(d.getDate()+7*task.interval);if(task.frequency==='monthly')d.setMonth(d.getMonth()+task.interval);if(task.frequency==='yearly')d.setFullYear(d.getFullYear()+task.interval);return formatISO(d);}
function completeToday(idx){
  const currentItems = [...todayData.linked, ...todayData.adHoc];
  if(idx < 0 || idx >= currentItems.length) return;
  
  const itemToComplete = currentItems[idx];
  
  // Use new completion API
  fetch('/api/today/complete', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ 
      id: itemToComplete.id,
      completed: true
    })
  }).then(res => res.json()).then(result => {
    if(result.success) {
      loadData().then(() => {
        rebuildToday();
        renderToday();
        updateToggles();
      });
    }
  }).catch(e => console.error('Failed to complete item:', e));
}
// Modal functionality for task selection
let modalCurrentWeekStart = new Date();

function openWeeklyTasksModal() {
  modalCurrentWeekStart = new Date();
  modalCurrentWeekStart.setDate(modalCurrentWeekStart.getDate() - modalCurrentWeekStart.getDay() + 1); // Start of current week (Monday)
  updateModalWeekLabel();
  renderModalWeeklyGrid();
  document.getElementById('weeklyTasksModal').style.display = 'block';
}

function closeWeeklyTasksModal() {
  document.getElementById('weeklyTasksModal').style.display = 'none';
}

function openOneOffTasksModal() {
  renderModalOneOffTable();
  document.getElementById('oneOffTasksModal').style.display = 'block';
}
function closeOneOffTasksModal() {
  document.getElementById('oneOffTasksModal').style.display = 'none';
}

function openRecurringTasksModal() {
  renderModalRecurringTable();
  document.getElementById('recurringTasksModal').style.display = 'block';
}
function closeRecurringTasksModal() {
  document.getElementById('recurringTasksModal').style.display = 'none';
}

function openWorkTasksModal() {
  renderModalWorkTable();
  document.getElementById('workTasksModal').style.display = 'block';
}
function closeWorkTasksModal() {
  document.getElementById('workTasksModal').style.display = 'none';
}

function openDiyTasksModal() {
  renderModalDiyTable();
  document.getElementById('diyTasksModal').style.display = 'block';
}
function closeDiyTasksModal() {
  document.getElementById('diyTasksModal').style.display = 'none';
}

function openBigTasksModal() {
  renderModalBigTable();
  document.getElementById('bigTasksModal').style.display = 'block';
}
function closeBigTasksModal() {
  document.getElementById('bigTasksModal').style.display = 'none';
}

function openStretchTasksModal() {
  renderModalStretchTable();
  document.getElementById('stretchTasksModal').style.display = 'block';
}
function closeStretchTasksModal() {
  document.getElementById('stretchTasksModal').style.display = 'none';
}

function changeModalWeek(direction) {
  modalCurrentWeekStart.setDate(modalCurrentWeekStart.getDate() + (direction * 7));
  updateModalWeekLabel();
  renderModalWeeklyGrid();
}

function updateModalWeekLabel() {
  const start = new Date(modalCurrentWeekStart);
  const end = new Date(modalCurrentWeekStart);
  end.setDate(end.getDate() + 6);
  document.getElementById('modalWeekLabel').textContent = 
    `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
}

// UK helpers for current-week highlighting and sorting
function ukDayIndex(date=new Date()){
  try{
    const short=new Intl.DateTimeFormat('en-GB',{weekday:'short',timeZone:'Europe/London'}).format(date);
    const map={Mon:0,Tue:1,Wed:2,Thu:3,Fri:4,Sat:5,Sun:6};
    if(short in map) return map[short];
  }catch(_){/* ignore */}
  const d=new Date(date).getDay();
  return d===0?6:d-1;
}
function ukDayName(date=new Date()){
  const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  try{
    const short=new Intl.DateTimeFormat('en-GB',{weekday:'short',timeZone:'Europe/London'}).format(date);
    if(names.includes(short)) return short;
  }catch(_){/* ignore */}
  return names[ukDayIndex(date)];
}
function isCurrentUKWeek(weekStart){
  return formatISO(startOfWeek(new Date()))===formatISO(startOfWeek(weekStart));
}
function weekISOArray(weekStart){
  const arr=[];for(let i=0;i<7;i++){const d=new Date(weekStart);d.setDate(weekStart.getDate()+i);arr.push(formatISO(d));}
  return arr;
}

function renderModalWeeklyGrid() {
  const grid = document.getElementById('modalWeeklyGrid');
  const headers = ['Task', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  
  grid.innerHTML = '';
  
  // Add headers
  const viewingCurrentWeek=isCurrentUKWeek(modalCurrentWeekStart);
  const todayIdx=ukDayIndex(new Date());
  const todayName=ukDayName(new Date());
  headers.forEach(headerText => {
    const header = document.createElement('div');
    header.className = 'grid-header';
    header.textContent = headerText;
    if(viewingCurrentWeek && headerText===todayName) header.classList.add('today-col');
    grid.appendChild(header);
  });
  
  // Add tasks
  let openTasks = weeklyTasks.filter(t => t.status === 'open');
  if (openTasks.length === 0) {
    const row = document.createElement('div');
    row.textContent = 'No weekly tasks';
    row.style.gridColumn = '1 / -1';
    row.style.textAlign = 'center';
    row.style.padding = '2rem';
    grid.appendChild(row);
    return;
  }
  if(viewingCurrentWeek){
    const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const weekISO=weekISOArray(modalCurrentWeekStart);
    const hasMissedEarlier=(task)=>{
      for(let i=0;i<todayIdx;i++){
        const day=names[i];
        if(task.days && task.days.includes(day)){
          const iso=weekISO[i];
          if(!task.completedDates.includes(iso)) return true;
        }
      }
      return false;
    };
    openTasks=openTasks.slice().sort((a,b)=>{
      const aDue=a.days && a.days.includes(todayName);
      const bDue=b.days && b.days.includes(todayName);
      if(aDue!==bDue) return aDue?-1:1;
      const aMiss=hasMissedEarlier(a);
      const bMiss=hasMissedEarlier(b);
      if(aMiss!==bMiss) return aMiss?-1:1;
      return (a.name||'').localeCompare(b.name||'');
    });
  }
  
  openTasks.forEach(task => {
    // Task cell with add to today button
    const taskCell = createModalTaskCell(task);
    grid.appendChild(taskCell);
    
    // Day cells
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach((day, idx) => {
      const cell = document.createElement('div');
      const date = new Date(modalCurrentWeekStart);
      date.setDate(modalCurrentWeekStart.getDate() + idx);
      const iso = formatISO(date);
      const due = task.days.includes(day);
      const completed = task.completedDates.includes(iso);
      
      const circle = document.createElement('span');
      circle.className = 'circle ' + (completed ? 'green' : due ? 'purple' : 'grey');
      circle.innerHTML = completed ? '&#10004;' : '';
      circle.onclick = () => toggleModalComplete(task.id, iso, due);
      if(viewingCurrentWeek && idx===todayIdx) cell.classList.add('today-col');
      cell.appendChild(circle);
      grid.appendChild(cell);
    });
  });
}

function renderModalOneOffTable() {
  const container = document.getElementById('modalOneOffTable');
  container.innerHTML = '';
  const open = (oneOffTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No one-off tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('oneoff', t.id, t.name);
    actionTd.appendChild(addBtn);
    const timerBtn = createTimerButton('todo', t.name);
    actionTd.appendChild(timerBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalRecurringTable() {
  const container = document.getElementById('modalRecurringTable');
  container.innerHTML = '';
  const open = (recurringTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No recurring tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Frequency</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const freqTd = document.createElement('td');
    freqTd.style.padding = '8px';
    const freq = t.frequency || '';
    const interval = t.interval || 1;
    freqTd.textContent = interval>1 ? `${interval} ${freq}` : freq;
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('recurring', t.id, t.name);
    actionTd.appendChild(addBtn);
    const timerBtn = createTimerButton('todo', t.name);
    actionTd.appendChild(timerBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(freqTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalWorkTable() {
  const container = document.getElementById('modalWorkTable');
  container.innerHTML = '';
  const rows = [];
  forEachWorkTask((t, depth) => {
    if (t.status !== 'open') return;
    rows.push({ t, depth });
  });
  if (rows.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No work tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Importance</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Urgency</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(({ t, depth }) => {
    const tr = document.createElement('tr');
    const projColor = (workDataStore.workProjects || []).find(p => p.name === t.project)?.color || '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    nameDiv.style.paddingLeft = (depth) + 'rem';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = projColor;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const impTd = document.createElement('td');
    impTd.style.padding = '8px';
    impTd.textContent = t.importance || '';
    const urgTd = document.createElement('td');
    urgTd.style.padding = '8px';
    urgTd.textContent = t.urgency || '';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('work', t.id, t.name);
    actionTd.appendChild(addBtn);
    const timerBtn = createTimerButton('work', t.name);
    actionTd.appendChild(timerBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(impTd);
    tr.appendChild(urgTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalDiyTable() {
  const container = document.getElementById('modalDiyTable');
  container.innerHTML = '';
  const rows = [];
  forEachDiyTask((t, depth) => {
    if (t.status !== 'open') return;
    rows.push({ t, depth });
  });
  if (rows.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No DIY tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Urgent</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach(({ t, depth }) => {
    const tr = document.createElement('tr');
    const projColor = (diyDataStore.diyProjects || []).find(p => p.name === t.project)?.color || '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    nameDiv.style.paddingLeft = (depth) + 'rem';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = projColor;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    const typeDiv = document.createElement('div');
    typeDiv.textContent = t.type || '';
    typeDiv.style.fontSize = '0.75rem';
    typeDiv.style.opacity = '0.8';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    taskTd.appendChild(typeDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const urgTd = document.createElement('td');
    urgTd.style.padding = '8px';
    urgTd.textContent = t.urgent ? 'Yes' : 'No';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('diy', t.id, t.name);
    actionTd.appendChild(addBtn);
    const timerBtn = createTimerButton('diy', t.name);
    actionTd.appendChild(timerBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(urgTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalBigTable() {
  const container = document.getElementById('modalBigTable');
  container.innerHTML = '';
  const open = (bigTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No big tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Due</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const dueTd = document.createElement('td');
    dueTd.style.padding = '8px';
    dueTd.textContent = t.dueDate ? formatUK(t.dueDate) : '';
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('big', t.id, t.name);
    actionTd.appendChild(addBtn);
    const timerBtn = createTimerButton('todo', t.name);
    actionTd.appendChild(timerBtn);
    tr.appendChild(taskTd);
    tr.appendChild(dueTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderModalStretchTable() {
  const container = document.getElementById('modalStretchTable');
  container.innerHTML = '';
  const open = (stretchTasks || []).filter(t => t.status === 'open');
  if (open.length === 0) {
    const empty = document.createElement('div');
    empty.textContent = 'No stretch tasks';
    empty.style.textAlign = 'center';
    empty.style.padding = '1rem';
    container.appendChild(empty);
    return;
  }
  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  const thead = document.createElement('thead');
  const headRow = document.createElement('tr');
  headRow.innerHTML = '<th style="text-align:left;border-bottom:1px solid #e2e5e9;padding:8px;">Task</th><th style="border-bottom:1px solid #e2e5e9;padding:8px;">Last Done</th><th style="min-width:120px;border-bottom:1px solid #e2e5e9;padding:8px;">Action</th>';
  thead.appendChild(headRow);
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  open.forEach(t => {
    const tr = document.createElement('tr');
    const proj = projects.find(p => p.name === t.project);
    const color = proj ? proj.color : '#2B2C29';
    const taskTd = document.createElement('td');
    taskTd.style.padding = '8px';
    const nameDiv = document.createElement('div');
    nameDiv.textContent = t.name;
    nameDiv.style.fontWeight = '500';
    const projDiv = document.createElement('div');
    projDiv.textContent = t.project || '';
    projDiv.style.color = color;
    projDiv.style.fontSize = '0.85rem';
    projDiv.style.marginTop = '2px';
    taskTd.appendChild(nameDiv);
    taskTd.appendChild(projDiv);
    const lastTd = document.createElement('td');
    lastTd.style.padding = '8px';
    const last = (t.completedDates && t.completedDates.length) ? formatUK(t.completedDates[t.completedDates.length-1]) : '';
    lastTd.textContent = last;
    const actionTd = document.createElement('td');
    actionTd.style.padding = '8px';
    const addBtn = document.createElement('button');
    addBtn.title = 'Add to Today';
    addBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
    addBtn.style.background = 'none';
    addBtn.style.border = 'none';
    addBtn.style.cursor = 'pointer';
    addBtn.onclick = () => addTaskToToday('stretch', t.id, t.name);
    actionTd.appendChild(addBtn);
    const timerBtn = createTimerButton('todo', t.name);
    actionTd.appendChild(timerBtn);
    tr.appendChild(taskTd);
    tr.appendChild(lastTd);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function createModalTaskCell(task) {
  const cell = document.createElement('div');
  cell.className = 'task-info';
  
  // Task details
  const detailsDiv = document.createElement('div');
  detailsDiv.className = 'task-details';
  
  const nameDiv = document.createElement('div');
  nameDiv.className = 'task-name';
  nameDiv.textContent = task.name;
  
  const projectDiv = document.createElement('div');
  projectDiv.className = 'task-meta';
  projectDiv.textContent = task.project;
  
  // Apply project color
  const proj = projects.find(p => p.name === task.project);
  if (proj) {
    projectDiv.style.color = proj.color;
  }
  
  detailsDiv.appendChild(nameDiv);
  detailsDiv.appendChild(projectDiv);
  
  // Actions
  const actionsDiv = document.createElement('div');
  actionsDiv.className = 'task-actions';
  
  // Add to Today button
  const addTodayBtn = document.createElement('button');
  addTodayBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="8" fill="#B8A4D9"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
  addTodayBtn.title = 'Add to Today';
  addTodayBtn.style.background = 'none';
  addTodayBtn.style.border = 'none';
  addTodayBtn.style.cursor = 'pointer';
  addTodayBtn.onclick = () => addTaskToToday('weekly', task.id, task.name);

  actionsDiv.appendChild(addTodayBtn);
  const timerBtn = createTimerButton('todo', task.name);
  actionsDiv.appendChild(timerBtn);

  cell.appendChild(detailsDiv);
  cell.appendChild(actionsDiv);
  
  return cell;
}

function toggleModalComplete(id, day, due) {
  const task = weeklyTasks.find(t => t.id === id);
  if (!task) return;
  
  if (task.completedDates.includes(day)) {
    task.completedDates = task.completedDates.filter(d => d !== day);
    if (due && new Date(day) < new Date()) {
      if (!task.missedDates.includes(day)) task.missedDates.push(day);
    }
  } else {
    task.completedDates.push(day);
    if (due) {
      task.missedDates = task.missedDates.filter(d => d !== day);
    }
  }
  
  saveData();
  renderModalWeeklyGrid();
}

async function addTaskToToday(taskType, taskId, taskName) {
  try {
    const response = await fetch('/api/add-to-today', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskType, taskId, taskName })
    });
    
    const result = await response.json();
    
    if (result.status === 'ok') {
      // Refresh data from server to get updated todayData structure
      await loadData();
      rebuildToday();
      renderTodayDataList();
      
      // Optionally refresh the modal grids to reflect any UI state
      if (document.getElementById('weeklyTasksModal').style.display === 'block') {
        renderModalWeeklyGrid();
      }
      if (document.getElementById('oneOffTasksModal').style.display === 'block') {
        renderModalOneOffTable();
      }
      if (document.getElementById('recurringTasksModal').style.display === 'block') {
        renderModalRecurringTable();
      }
      if (document.getElementById('workTasksModal').style.display === 'block') {
        renderModalWorkTable();
      }
      if (document.getElementById('diyTasksModal').style.display === 'block') {
        renderModalDiyTable();
      }
      if (document.getElementById('bigTasksModal').style.display === 'block') {
        renderModalBigTable();
      }
      if (document.getElementById('stretchTasksModal').style.display === 'block') {
        renderModalStretchTable();
      }
    } else if (result.status === 'already_exists') {
      alert('Task is already on today list');
    } else {
      alert('Failed to add task to Today list');
    }
  } catch (error) {
    console.error('Error adding task to Today:', error);
    alert('Error adding task to Today list');
  }
}

// Close modal when clicking outside
window.onclick = function(event) {
  const weekly = document.getElementById('weeklyTasksModal');
  const oneoff = document.getElementById('oneOffTasksModal');
  const recurring = document.getElementById('recurringTasksModal');
  if (event.target === weekly) closeWeeklyTasksModal();
  if (event.target === oneoff) closeOneOffTasksModal();
  if (event.target === recurring) closeRecurringTasksModal();
  const workM = document.getElementById('workTasksModal');
  const diyM = document.getElementById('diyTasksModal');
  const bigM = document.getElementById('bigTasksModal');
  const stretchM = document.getElementById('stretchTasksModal');
  if (event.target === workM) closeWorkTasksModal();
  if (event.target === diyM) closeDiyTasksModal();
  if (event.target === bigM) closeBigTasksModal();
  if (event.target === stretchM) closeStretchTasksModal();
}

// Today Data List Management Functions
async function addQuickTodayItem() {
  const input = document.getElementById('quickTodayItem');
  const text = input.value.trim();
  if (!text) return;
  
  try {
    const response = await fetch('/api/today/adhoc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    
    if (response.ok) {
      input.value = '';
      await loadData();
      renderTodayDataList();
    } else {
      alert('Failed to add item');
    }
  } catch (e) {
    console.error('Error adding quick item:', e);
    alert('Error adding item');
  }
}

async function removeTodayDataItem(id) {
  if (!confirm('Remove this item from today?')) return;
  
  try {
    const response = await fetch(`/api/today/${id}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      await loadData();
      renderTodayDataList();
    } else {
      alert('Failed to remove item');
    }
  } catch (e) {
    console.error('Error removing item:', e);
    alert('Error removing item');
  }
}

async function completeTodayDataItem(id) {
  try {
    const response = await fetch('/api/today/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ todayId: id, completed: true })
    });
    
    if (response.ok) {
      await loadData();
      renderTodayDataList();
      rebuildToday();
      renderToday();
    } else {
      alert('Failed to complete item');
    }
  } catch (e) {
    console.error('Error completing item:', e);
    alert('Error completing item');
  }
}

async function uncompleteTodayDataItem(id) {
  try {
    const response = await fetch('/api/today/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ todayId: id, completed: false })
    });
    
    if (response.ok) {
      await loadData();
      renderTodayDataList();
      rebuildToday();
      renderToday();
    } else {
      alert('Failed to uncomplete item');
    }
  } catch (e) {
    console.error('Error uncompleting item:', e);
    alert('Error uncompleting item');
  }
}

async function moveTodayDataItem(fromIndex, toIndex) {
  const allItems = [...todayData.linked, ...todayData.adHoc];
  const newOrder = allItems.map(item => item.id);
  
  // Move item from fromIndex to toIndex
  const [movedItem] = newOrder.splice(fromIndex, 1);
  newOrder.splice(toIndex, 0, movedItem);
  
  try {
    // Only reorder linked items using existing endpoint
    const linkedOrder = newOrder.filter(id => 
      todayData.linked.some(item => item.id == id)
    );
    
    const response = await fetch('/api/today/reorder', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ linkedOrder })
    });
    
    if (response.ok) {
      await loadData();
      renderTodayDataList();
    } else {
      alert('Failed to reorder items');
    }
  } catch (e) {
    console.error('Error reordering items:', e);
    alert('Error reordering items');
  }
}

function renderTodayDataList() {
  const container = document.getElementById('todayDataList');
  container.innerHTML = '';
  
  const allItems = [...todayData.linked, ...todayData.adHoc];
  
  if (allItems.length === 0) {
    container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">No items in today\'s list</div>';
    return;
  }
  
  allItems.forEach((item, index) => {
    const itemDiv = document.createElement('div');
    itemDiv.style.cssText = 'display: flex; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: white; border: 1px solid #e2e5e9; border-radius: 6px; gap: 0.5rem; cursor: grab; transition: all 0.2s ease;';
    
    // Make draggable
    itemDiv.draggable = true;
    itemDiv.dataset.index = index;
    itemDiv.dataset.itemId = item.id;
    
    // Check if item is completed
    const isCompleted = item.completedAt !== null && item.completedAt !== undefined;
    
    // Apply completion styling
    if (isCompleted) {
      itemDiv.style.opacity = '0.6';
      itemDiv.style.textDecoration = 'line-through';
      itemDiv.style.background = '#f8f9fa';
    }
    
    // Drag event handlers
    itemDiv.addEventListener('dragstart', handleDragStart);
    itemDiv.addEventListener('dragover', handleDragOver);
    itemDiv.addEventListener('drop', handleDrop);
    itemDiv.addEventListener('dragend', handleDragEnd);
    
    // Visual feedback on hover
    itemDiv.addEventListener('mouseenter', () => {
      itemDiv.style.transform = 'translateY(-1px)';
      itemDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
    });
    itemDiv.addEventListener('mouseleave', () => {
      itemDiv.style.transform = 'translateY(0)';
      itemDiv.style.boxShadow = 'none';
    });
    
    // Priority number
    const prioritySpan = document.createElement('span');
    prioritySpan.textContent = index + 1;
    prioritySpan.style.cssText = 'background: #B8A4D9; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0;';
    
    // Task name and details
    const taskDiv = document.createElement('div');
    taskDiv.style.cssText = 'flex: 1; min-width: 0;';
    
    const nameDiv = document.createElement('div');
    nameDiv.style.cssText = 'font-weight: 500; color: #2B2C29;';
    nameDiv.textContent = item.name || item.text || 'Untitled Task';
    
    const detailDiv = document.createElement('div');
    detailDiv.style.cssText = 'font-size: 0.85rem; color: #666; margin-top: 2px;';
    
    if (item.source) {
      // Linked task
      detailDiv.textContent = `From ${item.source.page}${item.source.type ? ` (${item.source.type})` : ''}`;
      detailDiv.style.color = '#B8A4D9';
    } else {
      // Ad-hoc task
      detailDiv.textContent = 'Quick item';
      detailDiv.style.color = '#81B29A';
    }
    
    taskDiv.appendChild(nameDiv);
    taskDiv.appendChild(detailDiv);
    
    // Action buttons
    const actionsDiv = document.createElement('div');
    actionsDiv.style.cssText = 'display: flex; gap: 0.25rem; flex-shrink: 0;';
    
    // Move up button
    if (index > 0) {
      const upBtn = document.createElement('button');
      upBtn.innerHTML = '↑';
      upBtn.title = 'Move up';
      upBtn.style.cssText = 'width: 28px; height: 28px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;';
      upBtn.onclick = (e) => { e.stopPropagation(); moveTodayDataItem(index, index - 1); };
      actionsDiv.appendChild(upBtn);
    }
    
    // Move down button
    if (index < allItems.length - 1) {
      const downBtn = document.createElement('button');
      downBtn.innerHTML = '↓';
      downBtn.title = 'Move down';
      downBtn.style.cssText = 'width: 28px; height: 28px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;';
      downBtn.onclick = (e) => { e.stopPropagation(); moveTodayDataItem(index, index + 1); };
      actionsDiv.appendChild(downBtn);
    }
    
    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.innerHTML = '✖';
    removeBtn.title = 'Remove from today';
    removeBtn.style.cssText = 'width: 28px; height: 28px; border: 1px solid #ff6b6b; background: white; color: #ff6b6b; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;';
    removeBtn.onclick = (e) => { e.stopPropagation(); removeTodayDataItem(item.id); };
    actionsDiv.appendChild(removeBtn);
    
    // Complete button
    const completeBtn = document.createElement('button');
    const itemCompleted = item.completedAt !== null && item.completedAt !== undefined;
    
    if (itemCompleted) {
      completeBtn.innerHTML = '↶';
      completeBtn.title = 'Mark incomplete';
      completeBtn.style.cssText = 'width: 28px; height: 28px; border: 1px solid #ffa500; background: white; color: #ffa500; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;';
      completeBtn.onclick = (e) => { e.stopPropagation(); uncompleteTodayDataItem(item.id); };
    } else {
      completeBtn.innerHTML = '✓';
      completeBtn.title = 'Mark complete';
      completeBtn.style.cssText = 'width: 28px; height: 28px; border: 1px solid #81B29A; background: white; color: #81B29A; border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center;';
      completeBtn.onclick = (e) => { e.stopPropagation(); completeTodayDataItem(item.id); };
    }
    actionsDiv.appendChild(completeBtn);
    
    itemDiv.appendChild(prioritySpan);
    itemDiv.appendChild(taskDiv);
    itemDiv.appendChild(actionsDiv);
    container.appendChild(itemDiv);
  });
}

// Drag and drop functionality for today list items
let draggedItem = null;

function handleDragStart(e) {
  draggedItem = this;
  this.style.opacity = '0.5';
  this.style.cursor = 'grabbing';
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/html', this.outerHTML);
}

function handleDragOver(e) {
  if (e.preventDefault) {
    e.preventDefault();
  }
  e.dataTransfer.dropEffect = 'move';
  
  // Visual feedback - highlight drop zone
  const draggedIndex = parseInt(draggedItem.dataset.index);
  const targetIndex = parseInt(this.dataset.index);
  
  if (draggedIndex !== targetIndex) {
    this.style.borderTop = targetIndex < draggedIndex ? '3px solid #B8A4D9' : '';
    this.style.borderBottom = targetIndex > draggedIndex ? '3px solid #B8A4D9' : '';
  }
  
  return false;
}

function handleDrop(e) {
  if (e.stopPropagation) {
    e.stopPropagation();
  }
  
  if (draggedItem !== this) {
    const draggedIndex = parseInt(draggedItem.dataset.index);
    const targetIndex = parseInt(this.dataset.index);
    
    if (draggedIndex !== targetIndex) {
      // Reorder the items using the existing moveTodayDataItem function
      moveTodayDataItem(draggedIndex, targetIndex);
    }
  }
  
  return false;
}

function handleDragEnd(e) {
  // Clean up visual feedback
  document.querySelectorAll('#todayDataList > div').forEach(item => {
    item.style.opacity = '';
    item.style.cursor = 'grab';
    item.style.borderTop = '';
    item.style.borderBottom = '';
  });
  
  draggedItem = null;
}

async function init(){await loadData();renderTodayDataList();}
init();
</script>
</body>
</html>